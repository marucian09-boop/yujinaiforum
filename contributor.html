<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum - Contributor Section</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5'%3E%3Cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z'/%3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Inter Font */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }
    /* Simple fade-in animation for elements */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    /* Toggle switch styles */
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4f46e5; }
    input:checked + .slider:before { transform: translateX(26px); }

    /* Custom styles for dark mode compatibility */
    .dark .bg-gray-100 { background-color: #1f2937; }
    .dark .bg-gray-200 { background-color: #374151; }
    .dark .text-gray-900 { color: #f9fafb; }
    .dark .text-gray-500 { color: #d1d5db; }
    .dark .text-gray-800 { color: #e5e7eb; }
    .dark .border-gray-300 { border-color: #4b5563; }
    .dark .ring-indigo-500 { ring-color: #818cf8; }
    .dark .placeholder-gray-400::placeholder { color: #9ca3af; }
    
    [contenteditable=true]:empty:before {
        content: attr(placeholder);
        pointer-events: none;
        display: block; /* For Firefox */
        color: #9ca3af;
    }
    .dark [contenteditable=true]:empty:before {
        color: #6b7280;
    }
    
    .dark .rich-text-btn {
        color: #e5e7eb;
        border-color: #4b5563;
    }

</style>
</head>
<body class="bg-gray-100">

<div id="app-container">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Community Forum</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfoContainer" class="flex items-center space-x-2" style="display: none;">
                        <span id="userName" class="text-sm font-medium text-gray-800 dark:text-gray-200"></span>
                        <span id="userRole" class="px-2 py-0.5 text-xs font-semibold text-white rounded-full"></span>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-gray-200 dark:bg-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-4 h-12">
                <a href="./index.html" class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Home</a>
                <a href="./contributor.html" class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 dark:bg-indigo-500 rounded-md">Contributor Section</a>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div id="loading-state" class="text-center text-gray-500">
            <p>Verifying access...</p>
        </div>

        <div id="contributor-content" style="display: none;" class="fade-in">
            <!-- Post Creation Section -->
            <section id="post-creation" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Create a Contributor Post</h2>
                <div class="space-y-4">
                    <input type="text" id="contributorPostTitle" placeholder="Post Title" class="w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <textarea id="contributorPostContent" placeholder="Share something with fellow contributors..." class="w-full h-28 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400" disabled></textarea>
                </div>
                <button id="createContributorPostBtn" class="mt-4 px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed dark:disabled:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all" disabled>Create Post</button>
            </section>

            <!-- Post List -->
            <div id="contributorPostList" class="mt-8 space-y-4">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="postViewModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl fade-in w-full max-w-2xl relative">
            <button id="closePostViewModal" class="absolute top-3 right-3 text-2xl font-light text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
            <h3 id="postViewTitle" class="text-xl font-bold text-gray-900 dark:text-white mb-2"></h3>
            <div id="postViewMeta" class="text-xs text-gray-500 dark:text-gray-400 mb-4"></div>
            <p id="postViewContent" class="text-gray-800 dark:text-gray-200 whitespace-pre-wrap"></p>
        </div>
    </div>
    
     <div id="alertModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl fade-in w-full max-w-sm text-center">
            <p id="alertMessage" class="text-gray-800 dark:text-gray-200 mb-4"></p>
            <button id="closeAlertModal" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">OK</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
      authDomain: "forum-3dec5.firebaseapp.com",
      databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-3dec5",
      storageBucket: "forum-3dec5.firebasestorage.app",
      messagingSenderId: "519284298976",
      appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
      measurementId: "G-SXS8FRTT03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const darkModeToggle = document.getElementById("darkModeToggle");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const contributorContent = document.getElementById("contributor-content");
    const loadingState = document.getElementById("loading-state");
    const createBtn = document.getElementById("createContributorPostBtn");
    const postTitleInput = document.getElementById("contributorPostTitle");
    const postContentInput = document.getElementById("contributorPostContent");
    const postList = document.getElementById("contributorPostList");
    const postViewModal = document.getElementById('postViewModal');
    const closePostViewModal = document.getElementById('closePostViewModal');
     const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeAlertModal = document.getElementById('closeAlertModal');

    let currentUserRole = null;
    let usersDataCache = {};
    let postDocsCache = [];

    function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.style.display = 'flex';
    }
    closeAlertModal.onclick = () => alertModal.style.display = 'none';

    // --- Dark Mode ---
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);

    darkModeToggle.addEventListener("change", (e) => {
        applyDarkMode(e.target.checked);
    });

    // --- Authentication & Authorization ---
    onAuthStateChanged(auth, async (user) => {
        if (user && !user.isAnonymous) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            
            // Fetch all users to get author names for posts
            const usersColRef = collection(db, "users");
            onSnapshot(usersColRef, (snapshot) => {
                snapshot.forEach(doc => {
                    usersDataCache[doc.id] = doc.data();
                });
            });

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                currentUserRole = userData.role || 'newbie';

                document.getElementById('userInfoContainer').style.display = 'flex';
                userNameEl.textContent = userData.displayName || user.email;
                userRoleEl.textContent = currentUserRole;
                userRoleEl.className = 'px-2 py-0.5 text-xs font-semibold text-white rounded-full';
                switch (currentUserRole) {
                    case 'admin': userRoleEl.classList.add('bg-violet-500'); break;
                    case 'contributor': userRoleEl.classList.add('bg-green-500'); break;
                    default: userRoleEl.classList.add('bg-blue-500'); break;
                }
                
                if (["admin", "contributor"].includes(currentUserRole)) {
                    loadingState.style.display = 'none';
                    contributorContent.style.display = 'block';
                    createBtn.disabled = false;
                    postContentInput.disabled = false;
                    loadContributorPosts();
                } else {
                    redirectToHome("Access denied. Contributors and Admins only.");
                }
            } else {
                 redirectToHome("User data not found.");
            }
        } else {
            redirectToHome("You must be signed in to view this page.");
        }
    });

    function redirectToHome(message) {
        console.log(message);
        alert(message);
        window.location.href = window.location.href.replace("contributor.html", "index.html");
    }

    // --- Post Management ---
    function loadContributorPosts() {
        const postsRef = collection(db, "contributorPosts");
        const q = query(postsRef, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            postDocsCache = snapshot.docs;
            renderContributorPosts();
        });
    }
    
    function renderContributorPosts() {
        postList.innerHTML = "";
        postDocsCache.forEach((docSnap) => {
            const post = docSnap.data();
            const postId = docSnap.id;
            const authorData = usersDataCache[post.authorId] || { displayName: 'Unknown' };

            const postEl = document.createElement("div");
            postEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md fade-in';
            const timestamp = post.createdAt ? post.createdAt.toDate().toLocaleString() : 'Just now';
            
            let adminControls = '';
            if (currentUserRole === 'admin') {
                 adminControls = `
                    <div class="ml-auto">
                        <button data-post-id="${postId}" class="delete-post-btn p-1 text-gray-400 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
            }
            
            postEl.innerHTML = `
                <div class="flex items-start">
                    <div>
                        <div class="font-bold text-gray-900 dark:text-white">${authorData.displayName}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${timestamp}</div>
                    </div>
                    ${adminControls}
                </div>
                <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mt-2 hover:underline cursor-pointer view-post-btn" data-post-id="${postId}">${post.title}</h4>
            `;
            postList.appendChild(postEl);
        });
    }

    createBtn.addEventListener("click", async () => {
        const title = postTitleInput.value.trim();
        const content = postContentInput.value.trim();
        const user = auth.currentUser;
        if (!title || !content || !user) {
            showAlert("Please provide a title and content for your post.");
            return;
        }
        
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);
        const authorName = userDocSnap.exists() ? userDocSnap.data().displayName : user.email;

        try {
            await addDoc(collection(db, "contributorPosts"), {
                title: title,
                content: content,
                authorName: authorName,
                authorId: user.uid,
                createdAt: serverTimestamp()
            });
            postTitleInput.value = "";
            postContentInput.value = "";
        } catch (error) {
            console.error("Error creating contributor post:", error);
            showAlert("Could not create post. Please try again.");
        }
    });
    
    postList.addEventListener('click', e => {
        const viewBtn = e.target.closest('.view-post-btn');
        const deleteBtn = e.target.closest('.delete-post-btn');

        if (viewBtn) {
            const postId = viewBtn.dataset.postId;
            const postDoc = postDocsCache.find(doc => doc.id === postId);
            if (postDoc) {
                const post = postDoc.data();
                const author = usersDataCache[post.authorId];
                document.getElementById('postViewTitle').textContent = post.title;
                document.getElementById('postViewContent').textContent = post.content;
                document.getElementById('postViewMeta').textContent = `Posted by ${author.displayName} on ${post.createdAt.toDate().toLocaleString()}`;
                postViewModal.style.display = 'flex';
            }
        }
        if (deleteBtn) {
            const postId = deleteBtn.dataset.postId;
            if (confirm('Are you sure you want to delete this post permanently?')) {
                deleteDoc(doc(db, "contributorPosts", postId)).then(() => {
                    showAlert('Post deleted successfully.');
                }).catch(err => console.error("Error deleting post:", err));
            }
        }
    });

    closePostViewModal.addEventListener('click', () => postViewModal.style.display = 'none');
</script>
</body>
</html>

