<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum - Contributor Section</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Inter Font */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }
    /* Simple fade-in animation for elements */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    /* Toggle switch styles */
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4f46e5; }
    input:checked + .slider:before { transform: translateX(26px); }

    /* Custom styles for dark mode compatibility */
    .dark .bg-gray-100 { background-color: #1f2937; }
    .dark .bg-gray-200 { background-color: #374151; }
    .dark .text-gray-900 { color: #f9fafb; }
    .dark .text-gray-500 { color: #d1d5db; }
    .dark .text-gray-800 { color: #e5e7eb; }
    .dark .border-gray-300 { border-color: #4b5563; }
    .dark .ring-indigo-500 { ring-color: #818cf8; }
    .dark .placeholder-gray-400::placeholder { color: #9ca3af; }
</style>
</head>
<body class="bg-gray-100">

<div id="app-container">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Community Forum</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfoContainer" class="flex items-center space-x-2">
                        <span id="userName" class="text-sm font-medium text-gray-800 dark:text-gray-200"></span>
                        <span id="userRole" class="px-2 py-0.5 text-xs font-semibold text-white rounded-full"></span>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-gray-200 dark:bg-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-4 h-12">
                <a href="./index.html" class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Home</a>
                <a href="./contributor.html" class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 dark:bg-indigo-500 rounded-md">Contributor Section</a>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div id="loading-state" class="text-center text-gray-500">
            <p>Verifying access...</p>
        </div>

        <div id="contributor-content" style="display: none;" class="fade-in">
             <!-- Post Creation Section -->
            <section id="post-creation" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Create a Contributor Post</h2>
                <textarea id="contributorPostContent" placeholder="Share something with fellow contributors..." class="w-full h-28 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400" disabled></textarea>
                <button id="createContributorPostBtn" class="mt-4 px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed dark:disabled:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all" disabled>Create Post</button>
            </section>

            <!-- Post List -->
            <div id="contributorPostList" class="mt-8 space-y-4">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
      authDomain: "forum-3dec5.firebaseapp.com",
      databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-3dec5",
      storageBucket: "forum-3dec5.firebasestorage.app",
      messagingSenderId: "519284298976",
      appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
      measurementId: "G-SXS8FRTT03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const darkModeToggle = document.getElementById("darkModeToggle");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const contributorContent = document.getElementById("contributor-content");
    const loadingState = document.getElementById("loading-state");
    const createBtn = document.getElementById("createContributorPostBtn");
    const postContent = document.getElementById("contributorPostContent");
    const postList = document.getElementById("contributorPostList");

    // --- Dark Mode ---
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);

    darkModeToggle.addEventListener("change", (e) => {
        applyDarkMode(e.target.checked);
    });

    // --- Authentication & Authorization ---
    onAuthStateChanged(auth, async (user) => {
        if (user && !user.isAnonymous) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                const userRole = userData.role || 'member';

                // Display user info and role with color coding
                userNameEl.textContent = user.displayName || user.email;
                userRoleEl.textContent = userRole;
                userRoleEl.classList.remove('bg-violet-500', 'bg-green-500', 'bg-blue-500');

                switch (userRole) {
                    case 'admin':
                        userRoleEl.classList.add('bg-violet-500');
                        break;
                    case 'contributor':
                        userRoleEl.classList.add('bg-green-500');
                        break;
                    default: // For 'member' or 'newbie'
                        userRoleEl.classList.add('bg-blue-500');
                        break;
                }
                
                // Authorize access to the page content
                if (["admin", "contributor"].includes(userRole)) {
                    loadingState.style.display = 'none';
                    contributorContent.style.display = 'block';
                    createBtn.disabled = false;
                    postContent.disabled = false;
                    loadContributorPosts();
                } else {
                    console.log("Access denied. User is not a contributor.");
                    alert("Access denied. This page is for contributors and admins only.");
                    window.location.href = window.location.href.replace("contributor.html", "index.html");
                }
            } else {
                 console.log("Access denied. User record not found in database.");
                 window.location.href = window.location.href.replace("contributor.html", "index.html");
            }
        } else {
            console.log("Access denied. User not signed in.");
            window.location.href = window.location.href.replace("contributor.html", "index.html");
        }
    });

    // --- Post Management ---
    function loadContributorPosts() {
        const postsRef = collection(db, "contributorPosts");
        const q = query(postsRef, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            postList.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const post = docSnap.data();
                const postEl = document.createElement("div");
                postEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md fade-in';
                const timestamp = post.createdAt ? post.createdAt.toDate().toLocaleString() : 'Just now';
                
                postEl.innerHTML = `
                    <div class="flex items-center mb-2">
                        <div class="font-bold text-gray-900 dark:text-white">${post.authorName}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 ml-auto">${timestamp}</div>
                    </div>
                    <p class="text-gray-800 dark:text-gray-200">${post.content}</p>
                `;
                postList.appendChild(postEl);
            });
        });
    }

    createBtn.addEventListener("click", async () => {
        const content = postContent.value.trim();
        const user = auth.currentUser;
        if (!content || !user) return;
        
        try {
            await addDoc(collection(db, "contributorPosts"), {
                content: content,
                authorName: user.displayName || user.email,
                authorId: user.uid,
                createdAt: serverTimestamp()
            });
            postContent.value = "";
        } catch (error) {
            console.error("Error creating contributor post:", error);
            alert("Could not create post. Please try again.");
        }
    });
</script>
</body>
</html>

