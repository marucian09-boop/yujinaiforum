<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum - Home</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M21 15a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v9zM5 7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H5zm4 5a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm5 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z'/%3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* =========================================
    Modern Design System for Community Forum
    =========================================
    */

    /* --- Font & Base --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root {
        --font-sans: 'Inter', sans-serif;
        
        /* Light Theme Colors */
        --bg-primary: #f8fafc; /* slate-50 */
        --bg-secondary: #ffffff; /* white */
        --bg-tertiary: #f1f5f9; /* slate-100 */
        --border-primary: #e2e8f0; /* slate-200 */
        --text-primary: #0f172a; /* slate-900 */
        --text-secondary: #64748b; /* slate-500 */
        --text-accent: #4f46e5; /* indigo-600 */
        --accent-primary: #4f46e5; /* indigo-600 */
        --accent-primary-hover: #4338ca; /* indigo-700 */
        --destructive: #dc2626; /* red-600 */
        --destructive-hover: #b91c1c; /* red-700 */
        --success: #16a34a; /* green-600 */
        --success-hover: #15803d; /* green-700 */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .dark {
        /* Dark Theme Colors */
        --bg-primary: #0f172a; /* slate-900 */
        --bg-secondary: #1e293b; /* slate-800 */
        --bg-tertiary: #334155; /* slate-700 */
        --border-primary: #334155; /* slate-700 */
        --text-primary: #f8fafc; /* slate-50 */
        --text-secondary: #94a3b8; /* slate-400 */
        --text-accent: #818cf8; /* indigo-400 */
        --accent-primary: #6366f1; /* indigo-500 */
        --accent-primary-hover: #818cf8; /* indigo-400 */
        --destructive: #f87171; /* red-400 */
        --destructive-hover: #ef4444; /* red-500 */
        --success: #4ade80; /* green-400 */
        --success-hover: #22c55e; /* green-500 */
    }

    body {
        font-family: var(--font-sans);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* --- Animations --- */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes modalEnter {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
    .modal-content-animation {
        animation: modalEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* --- Custom Components & Utilities --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
    }
    .btn:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
    }
    .btn-primary {
        background-color: var(--accent-primary);
        color: white;
    }
    .btn-primary:hover {
        background-color: var(--accent-primary-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .btn-primary:disabled {
        background-color: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .btn-success {
        background-color: var(--success);
        color: white;
    }
    .btn-success:hover {
        background-color: var(--success-hover);
    }
    .btn-danger {
        background-color: var(--destructive);
        color: white;
    }
    .btn-danger:hover {
        background-color: var(--destructive-hover);
    }
    .btn-secondary {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--border-primary);
    }
    .btn-secondary:hover {
        background-color: var(--bg-tertiary);
    }
    .btn-ghost {
        background-color: transparent;
        color: var(--text-secondary);
        box-shadow: none;
    }
    .btn-ghost:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .form-input {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border-radius: 0.5rem;
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }
    .form-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 20%, transparent);
    }
    
    .card {
        background-color: var(--bg-secondary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-primary);
        box-shadow: var(--shadow-md);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    
    .modal-overlay {
        background-color: rgb(0 0 0 / 0.5);
        backdrop-filter: blur(4px);
    }

    /* --- Toggle Switch --- */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: var(--shadow-sm); }
    input:checked + .slider { background-color: var(--accent-primary); }
    input:checked + .slider:before { transform: translateX(20px); }
    
    /* --- Rich Text Editor --- */
    .rich-text-editor {
        min-height: 100px;
        border-radius: 0.5rem;
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        padding: 0.75rem;
    }
    .rich-text-editor:focus-within {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 20%, transparent);
    }
    .rich-text-toolbar {
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .rich-text-btn {
        width: 32px;
        height: 32px;
        border-radius: 0.375rem;
        color: var(--text-secondary);
        background-color: transparent;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-primary);
    }
    .rich-text-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

    [contenteditable=true]:empty:before {
        content: attr(placeholder);
        pointer-events: none;
        display: block; /* For Firefox */
        color: var(--text-secondary);
        opacity: 0.7;
    }
    
    /* --- Inbox Specific Styles --- */
    .conversation-card {
        background-color: var(--bg-secondary);
        border-bottom: 1px solid var(--border-primary);
        transition: background-color 0.2s;
    }
    .conversation-card:hover {
        background-color: var(--bg-tertiary);
    }
    .message-bubble {
        padding: 0.75rem 1rem;
        border-radius: 1.25rem;
        max-width: 75%;
        position: relative;
    }
    .message-bubble.user {
        background-color: var(--accent-primary);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    .message-bubble.admin {
        background-color: var(--destructive);
        color: white;
        border-bottom-left-radius: 0.25rem;
    }
    .message-bubble.other {
         background-color: var(--bg-tertiary);
         color: var(--text-primary);
         border-bottom-left-radius: 0.25rem;
    }
    #message-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--accent-primary);
    }

    /* --- Notification Toast --- */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        z-index: 1050; /* Higher than modals */
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success { background-color: var(--success); }
    .toast.error { background-color: var(--destructive); }

</style>
</head>
<body>

<div id="app-container">
    <!-- Header -->
    <header class="bg-[var(--bg-secondary)]/80 backdrop-blur-lg sticky top-0 z-40 border-b border-[var(--border-primary)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row items-center justify-between py-4 sm:h-20">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-8 w-8 text-[var(--text-accent)]">
                        <path d="M4.913 2.658c1.072.454 1.99 1.374 2.536 2.446l.004-.001.002.001.002.001c.148.28.275.57.382.868H20.25a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75H3.75a.75.75 0 0 1-.75-.75V8.118c0-.35.07-.68.2-1l.001-.002.002-.003c.15-.29.32-.563.504-.815.42-.575.92-1.077 1.488-1.487l.002-.001.002-.002.001-.001A4.5 4.5 0 0 1 8.25 3.75h5.385c1.47 0 2.82.553 3.82 1.513l.002.002.001.001c.49.49.9 1.06 1.18 1.688l.002.003.001.002c.07.16.12.33.15.5H8.25a3 3 0 0 0-3 3v4.5a.75.75 0 0 1-1.5 0v-4.5a4.5 4.5 0 0 1 1.163-3.142Z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold text-[var(--text-primary)]">CommunityHub</h1>
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                    <div id="userInfoContainer" class="hidden items-center space-x-3 cursor-pointer group">
                        <span id="userName" class="text-sm font-semibold text-[var(--text-primary)] group-hover:text-[var(--text-accent)] transition-colors"></span>
                        <span id="userRole" class="px-2.5 py-1 text-xs font-bold text-white rounded-full"></span>
                    </div>
                    <div id="auth-container" class="flex items-center space-x-2">
                         <div class="text-right">
                            <p class="text-xs text-[var(--text-secondary)]">Have an account?</p>
                            <button id="signInLink" class="text-sm font-medium text-[var(--text-accent)] hover:underline">Sign in</button>
                        </div>
                        <div class="relative" id="createAccountDropdownContainer">
                            <button id="createAccountBtn" type="button" class="btn btn-primary">Create account</button>
                            <div id="createAccountDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[var(--bg-secondary)] rounded-lg shadow-lg py-1 z-50 border border-[var(--border-primary)]">
                                <a href="#" id="signUpWithGoogleBtn" class="flex items-center gap-2 px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]">Sign up with Google</a>
                                <a href="#" id="signUpWithEmailBtn" class="flex items-center gap-2 px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]">Sign up via email</a>
                            </div>
                        </div>
                    </div>
                    <button id="signOutBtn" type="button" style="display:none;" class="btn btn-danger">Sign out</button>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
             <div class="pb-4 flex flex-col sm:flex-row gap-2 justify-center sm:justify-end items-center space-x-4 text-xs text-[var(--text-secondary)]">
                <span><span class="font-bold text-[var(--text-primary)]" id="totalMembers">0</span> Total Members</span>
                <span class="hidden sm:block h-4 border-l border-[var(--border-primary)]"></span>
                <span><span class="font-bold text-[var(--text-primary)]" id="onlineVisitors">0</span> Online</span>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-[var(--bg-secondary)] border-b border-[var(--border-primary)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-wrap justify-center sm:justify-start items-center space-x-2 h-auto sm:h-14 py-2 sm:py-0">
                <a href="#" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Home</a>
                <a href="#" id="messagesBtn" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Messages</a>
                <a href="#" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Contributor Section</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Signup Form (hidden by default) -->
        <div id="signupForm" style="display:none;" class="mb-6 card p-6 fade-in">
            <h3 class="text-xl font-bold text-[var(--text-primary)] mb-4">Create an Account</h3>
            <div class="space-y-4">
                <div>
                    <input type="text" id="signupUsername" placeholder="Username" autocomplete="off" class="form-input">
                    <p id="signupUsernameError" class="text-xs text-[var(--destructive)] mt-1" style="display: none;"></p>
                </div>
                <input type="email" id="signupEmail" placeholder="Email address" autocomplete="off" class="form-input">
                <div>
                    <div class="relative">
                        <input type="password" id="signupPassword" placeholder="Password" autocomplete="new-password" class="form-input pr-10">
                        <button type="button" id="togglePasswordVisibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-[var(--text-secondary)]">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.02 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            <svg id="eyeSlashIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.955 9.955 0 00-4.502 1.071L3.707 2.293zM10.707 10.707a2 2 0 00-2.828-2.828l2.828 2.828zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M2.043 10c1.274 4.057 5.02 7 9.542 7 .848 0 1.67-.11 2.458-.316l-1.473-1.473A10.014 10.014 0 012.043 10z" /></svg>
                        </button>
                    </div>
                    <p id="passwordError" class="text-xs text-[var(--destructive)] mt-1" style="display: none;"></p>
                </div>
                <button id="signupBtn" class="btn btn-success w-full">Sign Up</button>
            </div>
        </div>
        
        <!-- Search Section -->
        <section id="search-section" class="mb-8">
            <div class="relative">
                 <input type="text" id="postSearchInput" placeholder="Search for a post..." class="form-input pl-10">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <div id="postSearchResults" class="mt-2 bg-[var(--bg-secondary)] rounded-lg shadow-lg border border-[var(--border-primary)]" style="display: none;"></div>
        </section>

        <!-- Post Creation Section -->
        <section id="post-creation" class="card p-6">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">Create a New Post</h2>
            <div class="space-y-4">
                <input type="text" id="postTitle" placeholder="Post Title" class="form-input">
                <textarea id="postContent" placeholder="What's on your mind?" class="form-input h-32" disabled></textarea>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                <button id="createPostBtn" class="btn btn-primary w-full sm:w-auto" disabled>Create Post</button>
                <p id="auth-prompt" class="text-sm text-[var(--destructive)] font-medium text-center sm:text-left">Please sign in to create a post.</p>
            </div>
        </section>

        <!-- Post List -->
        <div id="postList" class="mt-8 space-y-6">
            <!-- Posts will be dynamically inserted here -->
        </div>
        <div class="text-center mt-8">
            <button id="loadMoreBtn" style="display:none;" class="btn btn-primary">Load More Posts</button>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="userProfileModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-md modal-content-animation">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold text-[var(--text-primary)]">User Profile</h3>
                <button id="closeUserProfileModal" class="btn btn-ghost !p-1 h-8 w-8">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-[var(--text-primary)]">Total Posts: <span id="profilePostCount" class="font-bold">0</span></p>
                <div id="changeUsernameSection" style="display: none;" class="space-y-2">
                    <label for="newUsernameInput" class="block text-sm font-medium text-[var(--text-secondary)]">Change Username</label>
                    <div class="flex">
                        <input type="text" id="newUsernameInput" placeholder="New username" class="form-input rounded-r-none">
                        <button id="changeUsernameBtn" class="btn btn-primary rounded-l-none">Save</button>
                    </div>
                    <p id="changeUsernameError" class="text-xs text-[var(--destructive)] mt-1" style="display: none;"></p>
                </div>
                <button id="closeAccountBtn" class="btn btn-danger w-full">Close My Account</button>
            </div>
        </div>
    </div>

    <div id="postViewModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-2xl relative flex flex-col max-h-[85vh] modal-content-animation">
            <div class="flex-shrink-0">
                <button id="closePostViewModal" class="absolute top-3 right-3 btn btn-ghost !p-1 h-8 w-8 z-10">&times;</button>
                <h3 id="postViewTitle" class="text-2xl font-bold text-[var(--text-primary)] mb-2 pr-8"></h3>
                <div id="postViewMeta" class="text-sm text-[var(--text-secondary)] mb-4"></div>
            </div>
            <div class="overflow-y-auto pr-4 -mr-4">
                <p id="postViewContent" class="text-[var(--text-primary)] whitespace-pre-wrap leading-relaxed"></p>
            </div>
        </div>
    </div>

    <!-- INBOX / MESSAGING MODAL -->
    <div id="messagingModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-4xl h-[80vh] flex bg-[var(--bg-secondary)] rounded-2xl shadow-2xl overflow-hidden border border-[var(--border-primary)] modal-content-animation relative">
            <button id="closeMessagingModal" class="absolute top-3 right-3 btn btn-ghost !p-1 h-8 w-8 z-10">&times;</button>
            
            <!-- Conversation List -->
            <div class="w-1/3 border-r border-[var(--border-primary)] flex flex-col">
                <div class="p-4 border-b border-[var(--border-primary)]">
                    <h2 class="text-xl font-bold">Messages</h2>
                </div>
                <div id="conversation-list" class="flex-grow overflow-y-auto">
                    <!-- Conversation cards will be injected here -->
                </div>
            </div>

            <!-- Message Area -->
            <div class="w-2/3 flex flex-col">
                <div id="message-container" class="flex-grow p-6 overflow-y-auto space-y-4">
                    <!-- Messages will be injected here -->
                    <div class="flex items-center justify-center h-full">
                        <p class="text-[var(--text-secondary)]">Select a conversation to start messaging.</p>
                    </div>
                </div>
                <div class="p-4 border-t border-[var(--border-primary)] bg-[var(--bg-secondary)]">
                    <form id="message-form" class="flex items-center gap-4">
                        <div id="message-input" contenteditable="true" placeholder="Type a message..." class="w-full p-3 bg-[var(--bg-tertiary)] rounded-lg text-[var(--text-primary)]"></div>
                        <button type="submit" class="bg-[var(--accent-primary)] hover:bg-[var(--accent-primary-hover)] text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="signInModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm modal-content-animation">
            <div class="flex justify-between items-start mb-4"><h3 class="text-lg font-bold text-[var(--text-primary)]">Sign In</h3><button id="closeSignInModal" class="btn btn-ghost !p-1 h-8 w-8">&times;</button></div>
            <div class="space-y-4">
                <button id="signInWithGoogleBtnModal" class="w-full flex items-center justify-center btn btn-secondary"><svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.657-3.356-11.303-7.962l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C44.464,34.048,48,27.421,48,20c0-1.577-0.191-3.118-0.54-4.594l-0.231,0.195C45.696,17.227,44.254,19.14,43.611,20.083z"></path></svg>Sign in with Google</button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-[var(--border-primary)]"></div><span class="flex-shrink mx-4 text-[var(--text-secondary)]">or</span><div class="flex-grow border-t border-[var(--border-primary)]"></div></div>
                <input type="text" id="signInIdentifier" placeholder="Username or Email" class="form-input">
                <input type="password" id="signInPassword" placeholder="Password" class="form-input">
                <p id="signInError" class="text-xs text-[var(--destructive)] mt-1" style="display: none;"></p>
                <button id="signInWithEmailBtnModal" class="btn btn-success w-full">Sign In</button>
            </div>
        </div>
    </div>

    <div id="usernameModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm modal-content-animation">
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4">Choose a Username</h3>
            <p class="text-sm text-[var(--text-secondary)] mb-4">This will be your public name in the forum.</p>
            <input type="text" id="modalUsernameInput" placeholder="Enter a unique username" class="form-input">
            <p id="usernameError" class="text-xs text-[var(--destructive)] mt-1" style="display: none;"></p>
            <button id="submitUsernameBtn" class="mt-4 w-full btn btn-primary">Confirm Username</button>
        </div>
    </div>
    
    <div id="adminModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-md modal-content-animation">
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-2">Manage User</h3>
            <p id="adminModalUsername" class="text-sm font-medium text-[var(--text-accent)] mb-4"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)]">Send Warning</label>
                    <div id="warningMessage" contenteditable="true" placeholder="Enter warning message..." class="rich-text-editor mt-1 min-h-[50px]"></div>
                    <button id="sendWarningBtn" class="mt-2 w-full btn btn-primary bg-yellow-500 hover:bg-yellow-600">Send Warning to selected user</button>
                </div>
                <div class="flex space-x-4"><button id="banUserBtn" class="w-full btn btn-danger">Ban User</button><button id="unbanUserBtn" class="w-full btn btn-success">Unban User</button></div>
                <button id="closeAdminModal" class="mt-4 w-full btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="alertModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm text-center modal-content-animation">
            <p id="alertMessage" class="text-[var(--text-primary)] mb-4"></p>
            <button id="closeAlertModal" class="btn btn-primary">OK</button>
        </div>
    </div>

</div>

<!-- This is where notifications will appear -->
<div id="toast-container"></div>


<script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInAnonymously, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, onSnapshot, addDoc, query, orderBy, where, getDocs, updateDoc, deleteDoc, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
      authDomain: "forum-3dec5.firebaseapp.com",
      databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-3dec5",
      storageBucket: "forum-3dec5.firebasestorage.app",
      messagingSenderId: "519284298976",
      appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
      measurementId: "G-SXS8FRTT03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // --- GLOBAL STATE ---
    let currentUserRole = null;
    let usersDataCache = {};
    let postDocsCache = [];
    let currentConversationId = null;
    let currentUserData = null;
    let targetUserId = null; // For admin modal
    
    // --- UI ELEMENTS ---
    const signOutBtn = document.getElementById("signOutBtn");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const postList = document.getElementById("postList");
    const authContainer = document.getElementById("auth-container");
    const userInfoContainer = document.getElementById("userInfoContainer");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const messagesBtn = document.getElementById('messagesBtn');
    const messagingModal = document.getElementById('messagingModal');
    const closeMessagingModal = document.getElementById('closeMessagingModal');

    // --- Custom Alert Modal ---
    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeAlertModal = document.getElementById('closeAlertModal');

    function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.style.display = 'flex';
    }
    closeAlertModal.onclick = () => alertModal.style.display = 'none';
    
    // --- Notification Toast ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if(container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 500);
        }, 3000);
    }

    // --- Dark Mode ---
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);
    darkModeToggle.addEventListener("change", (e) => applyDarkMode(e.target.checked));


    // --- INBOX MESSAGING LOGIC ---
    function initInboxMessaging(currentUser) {
      const convoList = document.getElementById("conversation-list");
      const form = document.getElementById("message-form");
      const input = document.getElementById("message-input");

      const convoRef = collection(db, "conversations");
      const q = query(convoRef, orderBy("lastMessageTimestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        convoList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const convo = docSnap.data();
          if (!convo.participants.includes(currentUser.uid)) return;
          
          const otherUserId = convo.participants.find(id => id !== currentUser.uid);
          const otherUserData = usersDataCache[otherUserId];

          const div = document.createElement("div");
          div.className = "conversation-card p-4 cursor-pointer";
          div.innerHTML = `
            <strong class="block text-[var(--text-primary)]">${otherUserData ? otherUserData.displayName : '...'}</strong>
            <p class="text-sm text-[var(--text-secondary)] truncate">${convo.lastMessage || "New conversation"}</p>
            <span class="text-xs text-[var(--text-secondary)]">${new Date(convo.lastMessageTimestamp?.seconds * 1000).toLocaleTimeString()}</span>
          `;
          div.onclick = () => loadConversation(docSnap.id, currentUser);
          convoList.appendChild(div);
        });
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = input.innerHTML.trim();
        if (!content || !currentConversationId) {
            if(!currentConversationId) showToast("Please select a conversation first.", "error");
            return;
        };

        const msgRef = collection(db, `conversations/${currentConversationId}/messages`);
        try {
            await addDoc(msgRef, {
              content,
              sender: currentUser.email,
              timestamp: serverTimestamp(),
              reactions: {},
              deletedBy: [],
              role: currentUser.role || "user"
            });
            await updateDoc(doc(db, "conversations", currentConversationId), {
              lastMessage: content,
              lastMessageTimestamp: serverTimestamp()
            });
            input.innerHTML = "";
            showToast("Message sent successfully!", "success");
        } catch (error) {
            console.error("Error sending message: ", error);
            showToast("Failed to send message.", "error");
        }
      });
    }

    function loadConversation(convoId, currentUser) {
      currentConversationId = convoId;
      const msgRef = collection(db, `conversations/${convoId}/messages`);
      const q = query(msgRef, orderBy("timestamp"));
      const container = document.getElementById("message-container");

      onSnapshot(q, (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          if (msg.deletedBy?.includes(currentUser.uid)) return;
          
          const isCurrentUser = msg.sender === currentUser.email;
          const wrapper = document.createElement('div');
          wrapper.className = `flex w-full ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
          const div = document.createElement("div");
          
          let bubbleRole = 'other';
          if(isCurrentUser) bubbleRole = 'user';
          else if (msg.role === 'admin') bubbleRole = 'admin';
          
          div.className = `message-bubble ${bubbleRole}`;
          div.innerHTML = `
            <div class="font-bold text-sm mb-1">${msg.sender}</div>
            <div class="text">${msg.content}</div>
            <div class="reactions mt-2 flex items-center gap-2">
              ${renderReactions(msg.reactions)}
              <div class="reaction-buttons flex gap-1">
                 ${renderReactionButtons(docSnap.id)}
              </div>
            </div>
            <button class="delete-msg-btn absolute top-1 right-1 text-xs opacity-50 hover:opacity-100" data-id="${docSnap.id}">🗑️</button>
          `;
          wrapper.appendChild(div);
          container.appendChild(wrapper);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    function renderReactions(reactions = {}) {
      return Object.entries(reactions).map(([emoji, users]) =>
        `<span class="reaction bg-[var(--bg-tertiary)] text-xs font-medium px-2 py-1 rounded-full">${emoji} ${users.length}</span>`
      ).join('');
    }

    function renderReactionButtons(messageId) {
      const emojis = ['👍', '❤️', '😂'];
      return emojis.map(emoji => `
        <button data-emoji="${emoji}" data-message-id="${messageId}" class="p-1 rounded-full hover:bg-[var(--bg-tertiary)] transition-colors">${emoji}</button>
      `).join('');
    }

    document.getElementById('message-container').addEventListener("click", async (e) => {
        const currentUser = auth.currentUser;
        if(!currentUser || !currentConversationId) return;

        const btn = e.target.closest(".delete-msg-btn");
        if (btn) {
          const messageId = btn.dataset.id;
          await updateDoc(doc(db, `conversations/${currentConversationId}/messages`, messageId), {
            deletedBy: arrayUnion(currentUser.uid)
          });
        }

        const reactionBtn = e.target.closest("[data-emoji]");
        if (reactionBtn) {
          const emoji = reactionBtn.dataset.emoji;
          const messageId = reactionBtn.dataset.messageId;
          const messageRef = doc(db, `conversations/${currentConversationId}/messages`, messageId);
          const snap = await getDoc(messageRef);
          const data = snap.data();

          const updated = { ...data.reactions };
          if (!updated[emoji]) updated[emoji] = [];
          
          const userEmail = currentUser.email;
          const userIndex = updated[emoji].indexOf(userEmail);
          
          if(userIndex > -1){
            updated[emoji].splice(userIndex, 1);
            if(updated[emoji].length === 0) delete updated[emoji];
          } else {
             updated[emoji].push(userEmail);
          }
          await updateDoc(messageRef, { reactions: updated });
        }
    });
    // --- END INBOX LOGIC ---


    // --- Authentication Logic ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            setupPresence(user);
            attachFirestoreListeners();
            
            if (user.isAnonymous) {
                authContainer.style.display = 'flex';
                signOutBtn.style.display = 'none';
                userInfoContainer.style.display = 'none';
                document.getElementById("postContent").disabled = true;
                document.getElementById("createPostBtn").disabled = true;
                document.getElementById("auth-prompt").style.display = 'block';
            } else if (userDocSnap.exists()) {
                authContainer.style.display = 'none';
                signOutBtn.style.display = 'block';
                userInfoContainer.style.display = 'flex';
                document.getElementById("postContent").disabled = false;
                document.getElementById("createPostBtn").disabled = false;
                document.getElementById("auth-prompt").style.display = 'none';
                currentUserData = { ...userDocSnap.data(), uid: user.uid, email: user.email };
                currentUserRole = currentUserData.role || 'newbie';
                userNameEl.textContent = currentUserData.displayName || user.email;
                userRoleEl.textContent = currentUserData.banned ? 'Banned' : currentUserRole;
                // ... (rest of the role styling logic)

                initInboxMessaging(currentUserData); // Initialize inbox for logged-in user
            }
        } else {
            authContainer.style.display = 'flex';
            signOutBtn.style.display = 'none';
            userInfoContainer.style.display = 'none';
            document.getElementById("postContent").disabled = true;
            document.getElementById("createPostBtn").disabled = true;
            document.getElementById("auth-prompt").style.display = 'block';
            postList.innerHTML = '';
            currentUserRole = null;
            if(window.firestoreUnsubscribes) {
                window.firestoreUnsubscribes.forEach(unsub => unsub());
            }
            signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        }
    });

    function setupPresence(user) {
        if (!user) return;
        const myConnectionsRef = ref(rtdb, `status/${user.uid}`);
        const connectedRef = ref(rtdb, '.info/connected');
        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                set(myConnectionsRef, { online: true, last_changed: rtdbServerTimestamp() });
                onDisconnect(myConnectionsRef).remove();
            }
        });
    }
    
    // --- Firestore Listeners ---
    function attachFirestoreListeners() {
        if (window.firestoreUnsubscribes) {
             window.firestoreUnsubscribes.forEach(unsub => unsub());
        }
        window.firestoreUnsubscribes = [];

        const usersUnsub = onSnapshot(collection(db, "users"), (snapshot) => {
            document.getElementById("totalMembers").textContent = snapshot.size;
            snapshot.forEach(doc => {
                usersDataCache[doc.id] = doc.data();
            });
            renderPosts();
        });

        const presenceUnsub = onValue(ref(rtdb, "status"), (snapshot) => {
            document.getElementById("onlineVisitors").textContent = snapshot.exists() ? snapshot.size : 0;
        });

        const postsUnsub = onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "desc")), (snapshot) => {
            postDocsCache = snapshot.docs;
            renderPosts();
        });

        window.firestoreUnsubscribes.push(usersUnsub, presenceUnsub, postsUnsub);
    }
    
    function renderPosts() {
        postList.innerHTML = '';
        postDocsCache.forEach(doc => {
            const post = doc.data();
            const authorData = usersDataCache[post.authorId];
            if (!authorData) return;
            const postEl = document.createElement('div');
            postEl.className = 'card p-5';
            const timestamp = post.createdAt ? post.createdAt.toDate().toLocaleString() : 'Just now';
            // ... (rest of post rendering logic, it's quite long and unchanged) ...
             let adminControls = '';
            if (currentUserRole === 'admin') {
                adminControls = `
                    <div class="ml-auto flex items-center space-x-2">
                         <button data-author-id="${post.authorId}" class="manage-user-btn p-1 text-[var(--text-secondary)] hover:text-[var(--text-accent)]">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
            }
            postEl.innerHTML = `
                <div class="flex items-start flex-wrap">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <div class="font-bold text-[var(--text-primary)]">${authorData.displayName}</div>
                    </div>
                    ${adminControls}
                </div>
                <div class="text-xs text-[var(--text-secondary)]">${timestamp}</div>
                <h4 class="text-xl font-semibold text-[var(--text-accent)] mt-2 hover:underline cursor-pointer view-post-btn" data-post-id="${doc.id}">${post.title}</h4>
            `;
            postList.appendChild(postEl);
        });
    }

    // --- EVENT LISTENERS ---
    
    // Auth-related UI
    // ... (This section remains largely the same: sign-in modals, sign-up forms, etc.)

    // Open/Close Messaging Modal
    messagesBtn.addEventListener('click', () => {
        if(auth.currentUser && !auth.currentUser.isAnonymous){
            messagingModal.style.display = 'flex';
        } else {
            showAlert('Please sign in to view messages.');
        }
    });
    closeMessagingModal.addEventListener('click', () => {
         messagingModal.style.display = 'none';
    });

    // Admin Modal Logic
    function openAdminModal(userId) {
        targetUserId = userId;
        const userData = usersDataCache[userId];
        if(!userData) return;
        document.getElementById('adminModalUsername').textContent = userData.displayName;
        document.getElementById('warningMessage').innerHTML = '';
        document.getElementById('adminModal').style.display = 'flex';
    }
    
    document.getElementById('closeAdminModal').onclick = () => document.getElementById('adminModal').style.display = 'none';

    document.getElementById('banUserBtn').onclick = async () => {
        if (!targetUserId) return;
        await updateDoc(doc(db, "users", targetUserId), { banned: true });
        showToast('User has been banned.', 'success');
        document.getElementById('adminModal').style.display = 'none';
    };
    
    document.getElementById('unbanUserBtn').onclick = async () => {
        if (!targetUserId) return;
        await updateDoc(doc(db, "users", targetUserId), { banned: false });
        showToast('User has been unbanned.', 'success');
        document.getElementById('adminModal').style.display = 'none';
    };
    
    document.getElementById('sendWarningBtn').onclick = async () => {
        if (!targetUserId) {
            showToast('No user selected for warning.', 'error');
            return;
        }
        const message = document.getElementById('warningMessage').innerHTML.trim();
        if (!message) {
            showToast('Warning message cannot be empty.', 'error');
            return;
        }
        
        // Find or create conversation with the target user
        const user = auth.currentUser;
        const conversationId = [user.uid, targetUserId].sort().join('_');
        const convoRef = doc(db, 'conversations', conversationId);
        
        try {
            await setDoc(convoRef, {
                participants: [user.uid, targetUserId],
                lastMessage: `ADMIN WARNING: ${document.getElementById('warningMessage').textContent.trim()}`,
                lastMessageTimestamp: serverTimestamp()
            }, { merge: true });
            
            const msgRef = collection(db, `conversations/${conversationId}/messages`);
            await addDoc(msgRef, {
                content: message,
                sender: "Admin",
                timestamp: serverTimestamp(),
                role: 'admin',
                reactions: {},
                deletedBy: []
            });
            showToast('Warning sent successfully.', 'success');
            document.getElementById('adminModal').style.display = 'none';
        } catch(e) {
            showToast('Failed to send warning.', 'error');
            console.error(e);
        }
    };
    
    // Post list actions (view, manage)
    postList.addEventListener('click', e => {
        const viewBtn = e.target.closest('.view-post-btn');
        const manageBtn = e.target.closest('.manage-user-btn');

        if (viewBtn) {
            // ... view post logic ...
        }
        if (manageBtn) {
            const userId = manageBtn.dataset.authorId;
            openAdminModal(userId);
        }
    });

</script>
</body>
</html>
