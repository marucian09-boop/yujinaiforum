<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Ensure UTF-8 is declared first -->
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Forum</title>

  <!-- Favicon setup -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0a1a3f">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f5f5; }
    header { background-color: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 1.5rem; }
    header .auth-controls { display: flex; align-items: center; gap: 10px; }
    button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    #signInBtn { background-color: #4285F4; color: white; }
    #signOutBtn { background-color: #d9534f; color: white; }
    main { max-width: 800px; margin: 20px auto; padding: 0 15px; }
    section { background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    textarea { width: 100%; height: 80px; margin-top: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; resize: vertical; }
    #createPostBtn { background-color: #28a745; color: white; margin-top: 10px; }
    .post { background: #fafafa; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .stats { margin-top: 10px; font-size: 0.9rem; color: #ddd; }
    .badge { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.8rem; margin-left: 6px; }
    .badge.admin { background-color: violet; }
    .badge.member { background-color: green; }
    .admin-tools { margin-top: 5px; }
    .admin-tools button { margin-right: 5px; font-size: 0.8rem; padding: 4px 8px; }
  </style>
</head>
<body>

<header>
  <h1>Community Forum</h1>
  <div class="auth-controls">
    <span id="userEmail"></span>
    <button id="signInBtn">Sign in with Google</button>
    <button id="signOutBtn" style="display:none;">Sign out</button>
  </div>
  <div class="stats">
    <span id="totalMembers">0</span> Total Members |
    <span id="onlineVisitors">0</span> Online Visitors
  </div>
</header>

<main>
  <section>
    <h2>Create a New Post</h2>
    <textarea id="postContent" placeholder="Write something..."></textarea><br>
    <button id="createPostBtn" disabled>Create Post</button>
  </section>

  <section>
    <h2>Posts</h2>
    <div id="postList"></div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, getDocs, doc, getDoc, setDoc, deleteDoc, updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import {
    getDatabase, ref, onDisconnect, set, onValue
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
    authDomain: "forum-3dec5.firebaseapp.com",
    projectId: "forum-3dec5",
    storageBucket: "forum-3dec5.appspot.com",
    messagingSenderId: "519284298976",
    appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
    measurementId: "G-SXS8FRTT03",
    databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);
  const provider = new GoogleAuthProvider();

  let currentUserData = null;

  const signInBtn = document.getElementById("signInBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const userEmailEl = document.getElementById("userEmail");
  const createPostBtn = document.getElementById("createPostBtn");
  const postContentEl = document.getElementById("postContent");
  const postListEl = document.getElementById("postList");
  const totalMembersEl = document.getElementById("totalMembers");
  const onlineVisitorsEl = document.getElementById("onlineVisitors");

  signInBtn.addEventListener("click", () => {
    signInWithRedirect(auth, provider);
  });

  getRedirectResult(auth).then(async (result) => {
    if (result && result.user) {
      await ensureUserProfile(result.user);
    }
  });

  signOutBtn.addEventListener("click", async () => {
    await signOut
