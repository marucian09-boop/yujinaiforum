<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Community Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Community Forum</h1>
                <p class="text-gray-500">Discuss, share, and connect with others.</p>
            </div>
            <div id="auth-container" class="mt-4 sm:mt-0">
                <button id="login-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">Log In</button>
                <button id="signup-btn" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition ml-2">Sign Up</button>
                <div id="user-info" class="hidden items-center">
                    <p class="mr-4 font-semibold" id="user-email"></p>
                    <button id="logout-btn" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-600 transition">Logout</button>
                </div>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-2xl font-bold text-blue-500" id="member-count">0</p>
                <p class="text-gray-500">Total Members</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                 <p class="text-2xl font-bold text-green-500" id="visitor-count">1</p>
                <p class="text-gray-500">Online Visitors</p>
            </div>
        </div>

        <!-- Create Post Form (for logged-in users) -->
        <div id="create-post-form" class="hidden bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Create a New Post</h2>
            <textarea id="post-content" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="What's on your mind?"></textarea>
            <button id="submit-post-btn" class="mt-3 bg-blue-500 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition w-full sm:w-auto">Post</button>
        </div>

        <!-- Posts Feed -->
        <main id="posts-container">
            <!-- Posts will be dynamically inserted here -->
        </main>

    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6 text-center">Login to your Account</h2>
            <input type="email" id="login-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
            <input type="password" id="login-password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
            <button id="login-submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">Login</button>
            <p id="login-error" class="text-red-500 text-center mt-3"></p>
            <button id="close-login-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6 text-center">Create an Account</h2>
            <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
            <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
            <button id="signup-submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">Sign Up</button>
            <p id="signup-error" class="text-red-500 text-center mt-3"></p>
            <button id="close-signup-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Generic Modal for Alerts and Confirms -->
    <div id="generic-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <!-- Buttons are injected here by JS -->
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot,
            orderBy,
            doc,
            deleteDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            getDocs, 
            serverTimestamp,
            setLogLevel,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
        // This is now a fallback. The app will try to use a global config first.
        const firebaseConfigFallback = {
            apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
            authDomain: "forum-3dec5.firebaseapp.com",
            projectId: "forum-3dec5",
            storageBucket: "forum-3dec5.appspot.com",
            messagingSenderId: "519284298976",
            appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
            measurementId: "G-SXS8FRTT03"
        };
        // --- END: PASTE YOUR FIREBASE CONFIG HERE ---

        // --- START: PASTE YOUR ADMIN USER ID (UID) HERE ---
        const adminUID = "YOUR_ADMIN_UID_GOES_HERE";
        // --- END: PASTE YOUR ADMIN USER ID (UID) HERE ---

        let currentUser = null;
        let db;
        let auth;

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userEmailEl = document.getElementById('user-email');
        const createPostForm = document.getElementById('create-post-form');
        const postsContainer = document.getElementById('posts-container');
        const memberCountEl = document.getElementById('member-count');
        
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const closeLoginModal = document.getElementById('close-login-modal');
        const closeSignupModal = document.getElementById('close-signup-modal');

        const genericModal = document.getElementById('generic-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        // --- Modal Functions ---
        function showAlert(message, title = 'Alert') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button id="modal-ok-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">OK</button>`;
            genericModal.classList.add('active');
            document.getElementById('modal-ok-btn').onclick = () => {
                genericModal.classList.remove('active');
            };
        }

        function showConfirm(message, title = 'Confirm', onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">Confirm</button>
            `;
            genericModal.classList.add('active');

            document.getElementById('modal-confirm-btn').onclick = () => {
                genericModal.classList.remove('active');
                if (onConfirm) onConfirm();
            };
            document.getElementById('modal-cancel-btn').onclick = () => {
                genericModal.classList.remove('active');
            };
        }
        
        // --- App Initialization ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : firebaseConfigFallback;

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable detailed Firestore logging

                // Authenticate the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    // We now distinguish between an authenticated user and an anonymous one.
                    const isTrulyAuthenticated = user && !user.isAnonymous;
                    currentUser = user; // Store user regardless

                    if (isTrulyAuthenticated) {
                        loginBtn.classList.add('hidden');
                        signupBtn.classList.add('hidden');
                        userInfo.classList.remove('hidden');
                        userInfo.classList.add('flex');
                        userEmailEl.textContent = user.email;
                        createPostForm.classList.remove('hidden');
                    } else {
                        loginBtn.classList.remove('hidden');
                        signupBtn.classList.remove('hidden');
                        userInfo.classList.add('hidden');
                        userInfo.classList.remove('flex');
                        userEmailEl.textContent = '';
                        createPostForm.classList.add('hidden');
                    }
                    fetchPosts();
                });

                // Initial data fetch
                getMemberCount();

            } catch(error) {
                console.error("Firebase Initialization Error:", error);
                showAlert("Could not connect to the forum service. Please try again later.", "Connection Error");
            }
        }

        // --- Authentication Logic ---
        loginBtn.addEventListener('click', () => loginModal.classList.add('active'));
        signupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        closeLoginModal.addEventListener('click', () => {
            loginModal.classList.remove('active');
            document.getElementById('login-error').textContent = '';
        });
        closeSignupModal.addEventListener('click', () => {
            signupModal.classList.remove('active');
            document.getElementById('signup-error').textContent = '';
        });
        
        document.getElementById('signup-submit').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const userDoc = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDoc, { email: email });
                    signupModal.classList.remove('active');
                })
                .catch((error) => { errorEl.textContent = error.message; });
        });

        document.getElementById('login-submit').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            signInWithEmailAndPassword(auth, email, password)
                .then(() => { loginModal.classList.remove('active'); })
                .catch((error) => { errorEl.textContent = error.message; });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth)
                .then(() => signInAnonymously(auth)) // Revert to anonymous after logout
                .catch((error) => console.error("Logout Error:", error));
        });

        // --- Firestore Logic ---
        document.getElementById('submit-post-btn').addEventListener('click', async () => {
            const content = document.getElementById('post-content').value.trim();
            if (content && currentUser && !currentUser.isAnonymous) {
                try {
                    await addDoc(collection(db, 'posts'), {
                        content: content,
                        authorId: currentUser.uid,
                        authorEmail: currentUser.email,
                        createdAt: serverTimestamp(),
                        likes: [],
                        comments: []
                    });
                    document.getElementById('post-content').value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
        });

        function fetchPosts() {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                postsContainer.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    postsContainer.appendChild(createPostElement(doc.id, doc.data()));
                });
            });
        }
        
        function createPostElement(id, post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'bg-white p-5 rounded-lg shadow mb-4';
            const userLiked = currentUser && post.likes.includes(currentUser.uid);
            const isAdmin = currentUser && currentUser.uid === adminUID;
            const isAuthor = currentUser && currentUser.uid === post.authorId;

            let deleteButtonHTML = '';
            if (isAdmin || isAuthor) {
                deleteButtonHTML = `<button data-id="${id}" class="delete-post-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i> Delete</button>`;
            }
            
            postDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold text-gray-800">${post.authorEmail}</p>
                        <p class="text-sm text-gray-500">${post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : 'Just now'}</p>
                    </div>
                    ${deleteButtonHTML}
                </div>
                <p class="my-4 text-gray-700 break-words">${post.content}</p>
                <div class="flex items-center space-x-6 text-gray-500">
                    <button data-id="${id}" class="like-btn ${userLiked ? 'text-blue-500' : 'hover:text-blue-500'}">
                        <i class="fas fa-thumbs-up"></i> <span class="like-count">${post.likes.length}</span>
                    </button>
                    <button data-id="${id}" class="comment-btn hover:text-blue-500">
                        <i class="fas fa-comment"></i> ${post.comments.length}
                    </button>
                    <button data-id="${id}" class="share-btn hover:text-blue-500">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
                <div class="comment-section mt-4 pt-4 border-t border-gray-200 hidden">
                    <div class="comment-list">
                        ${post.comments.map(c => `<div class="bg-gray-50 p-2 rounded-lg mb-2"><p><strong>${c.authorEmail}:</strong> ${c.text}</p></div>`).join('')}
                    </div>
                    ${currentUser && !currentUser.isAnonymous ? `<div class="mt-2 flex">
                        <input type="text" class="comment-input w-full p-2 border border-gray-300 rounded-l-lg" placeholder="Write a comment...">
                        <button data-id="${id}" class="submit-comment-btn bg-blue-500 text-white px-4 rounded-r-lg hover:bg-blue-600">Post</button>
                    </div>` : ''}
                </div>`;
            return postDiv;
        }

        postsContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const isTrulyAuthenticated = currentUser && !currentUser.isAnonymous;

            if (target.classList.contains('delete-post-btn')) {
                showConfirm('Are you sure you want to delete this post? This cannot be undone.', 'Delete Post', async () => {
                    await deleteDoc(doc(db, "posts", id));
                });
            } else if (target.classList.contains('like-btn')) {
                if (!isTrulyAuthenticated) return showAlert('Please log in to like posts.');
                const postRef = doc(db, "posts", id);
                if (target.classList.contains('text-blue-500')) {
                    await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
                } else {
                    await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            } else if(target.classList.contains('comment-btn')) {
                target.closest('.p-5').querySelector('.comment-section').classList.toggle('hidden');
            } else if (target.classList.contains('submit-comment-btn')) {
                if (!isTrulyAuthenticated) return showAlert('Please log in to comment.');
                const input = target.previousElementSibling;
                const commentText = input.value.trim();
                if (commentText) {
                    const postRef = doc(db, "posts", id);
                    await updateDoc(postRef, { comments: arrayUnion({
                        authorId: currentUser.uid,
                        authorEmail: currentUser.email,
                        text: commentText,
                        createdAt: new Date()
                    }) });
                    input.value = '';
                }
            } else if (target.classList.contains('share-btn')) {
                const postURL = `${window.location.href.split('#')[0]}#post-${id}`;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(`Check out this post on our forum: ${postURL}`)
                        .then(() => showAlert('Post link copied to clipboard!'))
                        .catch(err => console.error('Failed to copy: ', err));
                } else {
                    showAlert('Cannot copy link on this browser.', 'Copy Failed');
                }
            }
        });
        
        function getMemberCount() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                memberCountEl.textContent = snapshot.size;
            });
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>

