<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum - Home</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M21 15a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v9zM5 7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H5zm4 5a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm5 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z'/%3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* =========================================
    Modern Design System for Community Forum
    =========================================
    */

    /* --- Font & Base --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root {
        --font-sans: 'Inter', sans-serif;
        
        /* Light Theme Colors */
        --bg-primary: #f8fafc; /* slate-50 */
        --bg-secondary: #ffffff; /* white */
        --bg-tertiary: #f1f5f9; /* slate-100 */
        --border-primary: #e2e8f0; /* slate-200 */
        --text-primary: #0f172a; /* slate-900 */
        --text-secondary: #64748b; /* slate-500 */
        --text-accent: #4f46e5; /* indigo-600 */
        --accent-primary: #4f46e5; /* indigo-600 */
        --accent-primary-hover: #4338ca; /* indigo-700 */
        --destructive: #dc2626; /* red-600 */
        --destructive-hover: #b91c1c; /* red-700 */
        --success: #16a34a; /* green-600 */
        --success-hover: #15803d; /* green-700 */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .dark {
        /* Dark Theme Colors */
        --bg-primary: #0f172a; /* slate-900 */
        --bg-secondary: #1e293b; /* slate-800 */
        --bg-tertiary: #334155; /* slate-700 */
        --border-primary: #334155; /* slate-700 */
        --text-primary: #f8fafc; /* slate-50 */
        --text-secondary: #94a3b8; /* slate-400 */
        --text-accent: #818cf8; /* indigo-400 */
        --accent-primary: #6366f1; /* indigo-500 */
        --accent-primary-hover: #818cf8; /* indigo-400 */
        --destructive: #f87171; /* red-400 */
        --destructive-hover: #ef4444; /* red-500 */
        --success: #4ade80; /* green-400 */
        --success-hover: #22c55e; /* green-500 */
    }

    body {
        font-family: var(--font-sans);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* --- Animations --- */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes modalEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(20px); } }
    
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    .modal-content-animation { animation: modalEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    /* --- Custom Components & Utilities --- */
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; box-shadow: var(--shadow-sm); }
    .btn:focus-visible { outline: 2px solid var(--accent-primary); outline-offset: 2px; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover { background-color: var(--accent-primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-success { background-color: var(--success); color: white; }
    .btn-success:hover { background-color: var(--success-hover); }
    .btn-danger { background-color: var(--destructive); color: white; }
    .btn-danger:hover { background-color: var(--destructive-hover); }
    .btn-secondary { background-color: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-primary); }
    .btn-secondary:hover { background-color: var(--bg-tertiary); }
    .btn-ghost { background-color: transparent; color: var(--text-secondary); box-shadow: none; }
    .btn-ghost:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .form-input { width: 100%; padding: 0.625rem 0.75rem; border-radius: 0.5rem; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.7; }
    .form-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .card { background-color: var(--bg-secondary); border-radius: 0.75rem; border: 1px solid var(--border-primary); box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .modal-overlay { background-color: rgb(0 0 0 / 0.5); backdrop-filter: blur(4px); }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: var(--shadow-sm); }
    input:checked + .slider { background-color: var(--accent-primary); }
    input:checked + .slider:before { transform: translateX(20px); }
    [contenteditable=true]:empty:before { content: attr(placeholder); pointer-events: none; display: block; color: var(--text-secondary); opacity: 0.7; }
    
    /* Gradient Text & Status Indicators */
    .gradient-text-admin { background: linear-gradient(90deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .gradient-text-contributor { background: linear-gradient(90deg, #22c55e, #84cc16); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .gradient-text-newbie { background: linear-gradient(90deg, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .online-indicator, .offline-indicator { width: 10px; height: 10px; border-radius: 50%; }
    .online-indicator { background-color: #22c55e; } /* green-500 */
    .offline-indicator { background-color: #94a3b8; } /* slate-400 */

    /* Toast Notifications */
    #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; box-shadow: var(--shadow-lg); animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; }
    .toast-success { background-color: var(--success); }
    .toast-error { background-color: var(--destructive); }
    
    /* Admin Warning Tool Modernization */
    .btn-warning-gradient {
        background: linear-gradient(90deg, #f97316, #f59e0b);
        color: white;
        border: none;
    }
    .btn-warning-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px -2px rgba(249, 115, 22, 0.4);
    }
    .warning-message-gradient {
        background: linear-gradient(90deg, rgba(249,115,22,0.1), rgba(245,158,11,0.1));
        border-color: #f97316;
        color: var(--text-primary);
        padding: 0.75rem;
    }
    .warning-message-gradient p {
        background: linear-gradient(90deg, #f97316, #ef4444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

</style>
</head>
<body>

<div id="app-container">
    <!-- Header -->
    <header class="bg-[var(--bg-secondary)]/80 backdrop-blur-lg sticky top-0 z-40 border-b border-[var(--border-primary)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row items-center justify-between py-4 sm:h-20">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-8 w-8 text-[var(--text-accent)]">
                        <path d="M4.913 2.658c1.072.454 1.99 1.374 2.536 2.446l.004-.001.002.001.002.001c.148.28.275.57.382.868H20.25a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75H3.75a.75.75 0 0 1-.75-.75V8.118c0-.35.07-.68.2-1l.001-.002.002-.003c.15-.29.32-.563.504-.815.42-.575.92-1.077 1.488-1.487l.002-.001.002-.002.001-.001A4.5 4.5 0 0 1 8.25 3.75h5.385c1.47 0 2.82.553 3.82 1.513l.002.002.001.001c.49.49.9 1.06 1.18 1.688l.002.003.001.002c.07.16.12.33.15.5H8.25a3 3 0 0 0-3 3v4.5a.75.75 0 0 1-1.5 0v-4.5a4.5 4.5 0 0 1 1.163-3.142Z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold text-[var(--text-primary)]">CommunityHub</h1>
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                    <div id="userInfoContainer" class="hidden items-center space-x-3 cursor-pointer group">
                        <span id="userName" class="text-sm font-semibold text-[var(--text-primary)] group-hover:text-[var(--text-accent)] transition-colors"></span>
                        <span id="userRole" class="px-2.5 py-1 text-xs font-bold text-white rounded-full"></span>
                    </div>
                    <div id="auth-container" class="flex items-center space-x-2">
                         <div class="text-right">
                            <p class="text-xs text-[var(--text-secondary)]">Have an account?</p>
                            <button id="signInLink" class="text-sm font-medium text-[var(--text-accent)] hover:underline">Sign in</button>
                        </div>
                        <div class="relative" id="createAccountDropdownContainer">
                            <button id="createAccountBtn" type="button" class="btn btn-primary">Create account</button>
                            <div id="createAccountDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[var(--bg-secondary)] rounded-lg shadow-lg py-1 z-50 border border-[var(--border-primary)]">
                                <a href="#" id="signUpWithGoogleBtn" class="flex items-center gap-2 px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]">Sign up with Google</a>
                                <a href="#" id="signUpWithEmailBtn" class="flex items-center gap-2 px-4 py-2 text-sm text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]">Sign up via email</a>
                            </div>
                        </div>
                    </div>
                    <button id="signOutBtn" type="button" style="display:none;" class="btn btn-danger">Sign out</button>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
             <div class="pb-4 flex flex-col sm:flex-row gap-2 justify-center sm:justify-end items-center space-x-4 text-xs text-[var(--text-secondary)]">
                <span><span class="font-bold text-[var(--text-primary)]" id="totalMembers">0</span> Total Members</span>
                <span class="hidden sm:block h-4 border-l border-[var(--border-primary)]"></span>
                <span><span class="font-bold text-[var(--text-primary)]" id="onlineVisitors">0</span> Online</span>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-[var(--bg-secondary)] border-b border-[var(--border-primary)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-wrap justify-center sm:justify-start items-center space-x-2 h-auto sm:h-14 py-2 sm:py-0">
                <a href="./index.html" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Home</a>
                <a href="#" id="messagesBtn" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Messages</a>
                <a href="./contributor.html" class="px-3 py-2 text-sm font-medium text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-primary)] transition-colors">Contributor Section</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Forms and Post sections remain unchanged -->
        <div id="signupForm" style="display:none;" class="mb-6 card p-6 fade-in">...</div>
        <section id="search-section" class="mb-8 flex flex-col sm:flex-row gap-2">...</section>
        <section id="post-creation" class="card p-6">...</section>
        <div id="postList" class="mt-8 space-y-6"></div>
    </main>
    
    <!-- Modals -->
    <div id="confirmModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>
    <div id="editPostModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>
    <div id="userProfileModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>
    <div id="postViewModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>
    <div id="signInModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>
    <div id="usernameModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">...</div>

    <!-- Inbox/Members List Modal -->
    <div id="inboxModal" style="display:none;" class="fixed inset-0 modal-overlay overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-md h-[75vh] flex flex-col modal-content-animation">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-[var(--text-primary)]">Members</h3>
                <button id="closeInboxModal" class="btn btn-ghost !p-1 h-8 w-8">&times;</button>
            </div>
            <div id="memberList" class="flex-grow overflow-y-auto space-y-2 pr-2 -mr-2">
                <!-- Member list will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" style="display:none;" class="fixed top-0 right-0 h-full w-full max-w-md z-50">
         <div class="card !rounded-l-lg !rounded-r-none h-full w-full flex flex-col modal-content-animation border-r-0">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-primary)]">
                <div id="chatHeader" class="font-bold text-[var(--text-primary)]"></div>
                <button id="closeChatModal" class="btn btn-ghost !p-1 h-8 w-8">&times;</button>
            </div>
            <div id="messageHistory" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
            <div class="p-4 border-t border-[var(--border-primary)]">
                 <textarea id="messageInput" placeholder="Type your message..." class="form-input h-20 mb-2"></textarea>
                 <button id="sendMessageBtn" class="btn btn-primary w-full">Send Message</button>
            </div>
         </div>
    </div>
    
    <!-- Admin Modal -->
    <div id="adminModal" style="display:none;" class="fixed inset-0 modal-overlay z-50 ...">
        <div class="card p-6 w-full max-w-md modal-content-animation">
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-2">Manage User</h3>
            <p id="adminModalUsername" class="text-sm font-medium text-[var(--text-accent)] mb-4"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)]">Send Warning</label>
                    <div id="warningMessage" contenteditable="true" placeholder="Enter warning message..." class="form-input mt-1 h-24 warning-message-gradient"></div>
                    <button id="sendWarningBtn" class="mt-2 w-full btn btn-warning-gradient">Send Warning</button>
                </div>
                <div class="flex space-x-4"><button id="banUserBtn" class="w-full btn btn-danger">Ban User</button><button id="unbanUserBtn" class="w-full btn btn-success">Unban User</button></div>
                <button id="closeAdminModal" class="mt-4 w-full btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script type="module">
    // Firebase imports (already present, no changes here)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, onSnapshot, addDoc, query, orderBy, where, getDocs, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- Firebase Config and Initialization ---
    // IMPORTANT: Replace with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
      authDomain: "forum-3dec5.firebaseapp.com",
      databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-3dec5",
      storageBucket: "forum-3dec5.firebasestorage.app",
      messagingSenderId: "519284298976",
      appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
      measurementId: "G-SXS8FRTT03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    // --- DOM Elements ---
    const messagesBtn = document.getElementById('messagesBtn');
    const inboxModal = document.getElementById('inboxModal');
    const closeInboxModal = document.getElementById('closeInboxModal');
    const memberList = document.getElementById('memberList');

    const chatModal = document.getElementById('chatModal');
    const closeChatModal = document.getElementById('closeChatModal');
    const chatHeader = document.getElementById('chatHeader');
    const messageHistory = document.getElementById('messageHistory');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const adminModal = document.getElementById('adminModal');
    const warningMessage = document.getElementById('warningMessage');
    const sendWarningBtn = document.getElementById('sendWarningBtn');

    // --- App State ---
    let onlineUsers = {};
    let allUsers = {};
    let currentChatRecipient = null;
    let messageListenerUnsubscribe = null;

    // --- Toast Notification Function ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // --- Auth State and Presence Management ---
    onAuthStateChanged(auth, user => {
        if (user) {
            setupPresence(user);
            attachMainListeners();
        } else {
            signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed", err));
        }
    });

    function setupPresence(user) {
        const myConnectionsRef = ref(rtdb, `status/${user.uid}`);
        const connectedRef = ref(rtdb, '.info/connected');
        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                set(myConnectionsRef, { online: true, last_changed: rtdbServerTimestamp() });
                onDisconnect(myConnectionsRef).remove();
            }
        });
    }

    function attachMainListeners() {
        // Listen for online status changes
        const statusRef = ref(rtdb, "status");
        onValue(statusRef, (snapshot) => {
            onlineUsers = snapshot.val() || {};
            document.getElementById("onlineVisitors").textContent = Object.keys(onlineUsers).length;
            renderMembersList(); // Re-render list on status change
        });

        // Listen for user data changes
        const usersColRef = collection(db, "users");
        onSnapshot(usersColRef, (snapshot) => {
            snapshot.forEach(doc => {
                allUsers[doc.id] = doc.data();
            });
            document.getElementById("totalMembers").textContent = snapshot.size;
            renderMembersList(); // Re-render list on user data change
        });
    }

    // --- Inbox & Chat UI Logic ---
    messagesBtn.addEventListener('click', () => {
        if (auth.currentUser && !auth.currentUser.isAnonymous) {
            inboxModal.style.display = 'flex';
        } else {
            showToast('Please sign in to use messaging.', 'error');
        }
    });
    closeInboxModal.onclick = () => inboxModal.style.display = 'none';
    closeChatModal.onclick = () => {
        chatModal.style.display = 'none';
        if (messageListenerUnsubscribe) messageListenerUnsubscribe();
        currentChatRecipient = null;
    };

    function getRoleUI(role) {
        let badgeColor = 'bg-blue-500';
        let gradientClass = 'gradient-text-newbie';
        if (role === 'admin') {
            badgeColor = 'bg-violet-500';
            gradientClass = 'gradient-text-admin';
        } else if (role === 'contributor') {
            badgeColor = 'bg-green-500';
            gradientClass = 'gradient-text-contributor';
        }
        return { badgeColor, gradientClass };
    }

    function renderMembersList() {
        if (!memberList || inboxModal.style.display === 'none') return;
        memberList.innerHTML = '';
        
        // Hardcoded sample users for demonstration
        const hardcodedUsers = {
            'sampleAdmin1': { displayName: 'AdminUser', role: 'admin' },
            'sampleContrib1': { displayName: 'TopContributor', role: 'contributor' },
            'sampleNewbie1': { displayName: 'NewUser', role: 'newbie' },
        };
        const combinedUsers = {...allUsers, ...hardcodedUsers};

        Object.entries(combinedUsers).forEach(([uid, userData]) => {
            if (uid === auth.currentUser?.uid) return;

            const isOnline = onlineUsers[uid]?.online || (uid.startsWith('sample') && Math.random() > 0.5);
            const { badgeColor, gradientClass } = getRoleUI(userData.role);

            const memberEl = document.createElement('div');
            memberEl.className = 'flex items-center p-2 rounded-lg hover:bg-[var(--bg-tertiary)] cursor-pointer';
            memberEl.dataset.uid = uid;
            memberEl.dataset.name = userData.displayName;

            memberEl.innerHTML = `
                <div class="flex-shrink-0 mr-3">
                    <div class="${isOnline ? 'online-indicator' : 'offline-indicator'}"></div>
                </div>
                <div class="flex-grow">
                    <p class="font-bold ${gradientClass}">${userData.displayName}</p>
                    <p class="text-xs text-[var(--text-secondary)] capitalize">${userData.role || 'newbie'}</p>
                </div>
                <span class="px-2 py-0.5 text-xs font-bold text-white rounded-full ${badgeColor}">${userData.role || 'newbie'}</span>
            `;
            memberEl.onclick = () => openChat(uid, userData.displayName);
            memberList.appendChild(memberEl);
        });
    }

    function openChat(uid, name) {
        currentChatRecipient = { uid, name };
        chatHeader.textContent = `Chat with ${name}`;
        chatModal.style.display = 'block';
        inboxModal.style.display = 'none';
        messageHistory.innerHTML = ''; // Clear previous messages
        loadMessageHistory();
    }

    async function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !currentChatRecipient || !auth.currentUser) return;

        const conversationId = [auth.currentUser.uid, currentChatRecipient.uid].sort().join('_');
        const messagesRef = collection(db, `conversations/${conversationId}/messages`);
        const conversationRef = doc(db, 'conversations', conversationId);

        try {
            // Add the message
            await addDoc(messagesRef, {
                senderId: auth.currentUser.uid,
                content: content,
                createdAt: serverTimestamp()
            });

            // Update the conversation document for inbox view
            await setDoc(conversationRef, {
                participants: [auth.currentUser.uid, currentChatRecipient.uid],
                lastMessage: content,
                lastMessageTimestamp: serverTimestamp(),
            }, { merge: true });

            messageInput.value = '';
            showToast('Message sent successfully!', 'success');
        } catch (error) {
            console.error("Error sending message:", error);
            showToast('Failed to send message.', 'error');
        }
    }
    sendMessageBtn.onclick = sendMessage;

    function loadMessageHistory() {
        if (messageListenerUnsubscribe) messageListenerUnsubscribe();
        if (!currentChatRecipient || !auth.currentUser) return;

        const conversationId = [auth.currentUser.uid, currentChatRecipient.uid].sort().join('_');
        const messagesRef = collection(db, `conversations/${conversationId}/messages`);
        const q = query(messagesRef, orderBy('createdAt'));

        messageListenerUnsubscribe = onSnapshot(q, (snapshot) => {
            messageHistory.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const msgEl = document.createElement('div');
                const isSender = msg.senderId === auth.currentUser.uid;
                
                msgEl.className = `p-3 rounded-lg my-1 max-w-xs break-words ${isSender ? 'bg-[var(--accent-primary)] text-white ml-auto' : 'bg-[var(--bg-secondary)] text-[var(--text-primary)] mr-auto shadow-sm'}`;
                msgEl.textContent = msg.content;
                messageHistory.appendChild(msgEl);
            });
            messageHistory.scrollTop = messageHistory.scrollHeight;
        });
    }
    
    // --- Admin Warning Logic ---
    let targetUserId = null; // Assume this gets set when admin modal opens
    sendWarningBtn.onclick = async () => {
        const messageText = warningMessage.textContent.trim();
        if (!messageText || !targetUserId) {
            showToast('User or message is missing.', 'error');
            return;
        }

        // Apply gradient styling for the message
        const styledContent = `<p class="font-bold">${messageText}</p>`;

        const conversationId = [auth.currentUser.uid, targetUserId].sort().join('_');
        const messagesRef = collection(db, `conversations/${conversationId}/messages`);

        try {
            await addDoc(messagesRef, {
                senderId: auth.currentUser.uid,
                content: styledContent,
                isWarning: true, // Custom flag for styling
                createdAt: serverTimestamp()
            });
            showToast('Warning sent successfully.', 'success');
            adminModal.style.display = 'none';
        } catch (error) {
            console.error("Error sending warning:", error);
            showToast('Failed to send warning.', 'error');
        }
    };
    
    // NOTE: The rest of your existing JS for posts, auth modals, etc. would go here.
    // I've omitted it for brevity but it should be included in the final file.
    // This example focuses on implementing the requested changes.

</script>
</body>
</html>

