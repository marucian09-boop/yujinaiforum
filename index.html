<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for a cleaner look */
    .modal-content::-webkit-scrollbar { width: 8px; }
    .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body class="h-full font-sans bg-gray-100 text-gray-800">

<div id="app" class="flex flex-col h-full">
  <!-- Header -->
  <header class="bg-white shadow-md w-full sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <h1 class="text-2xl font-bold text-gray-900">Community Forum</h1>
        <div class="flex items-center space-x-4">
          <div id="auth-container" class="flex items-center space-x-3">
            <span id="userEmail" class="text-sm font-medium text-gray-600 hidden sm:block"></span>
            <button id="signInBtn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
              Sign In
            </button>
            <button id="signOutBtn" class="hidden px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
              Sign Out
            </button>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-200 py-2 text-xs text-gray-500 flex items-center justify-center sm:justify-start space-x-4">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.282-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.282.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span id="totalMembers">0</span>&nbsp;Total Members
        </div>
        <div class="flex items-center">
             <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span id="onlineVisitors">0</span>&nbsp;Online
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-4xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Create Post Section -->
    <section id="create-post-section" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
      <h2 class="text-xl font-bold mb-4">Create a New Post</h2>
      <input type="text" id="postTitle" placeholder="Post Title" maxlength="120" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition mb-4">
      <textarea id="postContent" placeholder="Write something..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition h-32 resize-none"></textarea>
      <button id="createPostBtn" disabled class="mt-4 w-full sm:w-auto px-6 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
        Create Post
      </button>
    </section>

    <!-- Login Prompt Section -->
    <section id="login-prompt-section" class="bg-white p-6 rounded-lg shadow-md mb-8 text-center">
        <h2 class="text-xl font-bold mb-2">Join the Conversation!</h2>
        <p class="text-gray-600 mb-4">Please sign in to create new posts and engage with the community.</p>
        <button id="promptSignInBtn" class="px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
              Sign In with Google
        </button>
    </section>

    <!-- Posts Section -->
    <section>
      <h2 class="text-2xl font-bold mb-4">Posts</h2>
      <div id="postList" class="space-y-4">
        <!-- Posts will be dynamically inserted here -->
         <div class="text-center text-gray-500 py-10">Loading posts...</div>
      </div>
    </section>
  </main>
</div>

<!-- Modal -->
<div id="postModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-bold">Loading...</h2>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600 transition">&times;</button>
    </div>
    <div id="modalBody" class="p-6 overflow-y-auto modal-content prose max-w-none">
      <p>Loading content...</p>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getDatabase, ref, onDisconnect, set, onValue, serverTimestamp as dbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  // --- Firebase Configuration ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const rtdbAppId = appId.replace(/\./g, '_'); // Sanitize for Realtime Database paths
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  
  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);
  const provider = new GoogleAuthProvider();

  // --- DOM Elements ---
  const signInBtn = document.getElementById("signInBtn");
  const promptSignInBtn = document.getElementById("promptSignInBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const userEmailEl = document.getElementById("userEmail");
  const createPostBtn = document.getElementById("createPostBtn");
  const postTitleEl = document.getElementById("postTitle");
  const postContentEl = document.getElementById("postContent");
  const postListEl = document.getElementById("postList");
  const totalMembersEl = document.getElementById("totalMembers");
  const onlineVisitorsEl = document.getElementById("onlineVisitors");
  const createPostSection = document.getElementById('create-post-section');
  const loginPromptSection = document.getElementById('login-prompt-section');
  const modal = document.getElementById('postModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const closeModalBtns = document.querySelectorAll('.close-modal-btn');

  // --- Paths ---
  const usersPath = `artifacts/${appId}/public/data/users`;
  const postsPath = `artifacts/${appId}/public/data/posts`;
  const statusPath = `artifacts/${rtdbAppId}/public/data/status`;

  let currentUnsubscribePost = null;

  // Enable/disable Create Post button automatically
  function validatePostForm() {
    const hasTitle = postTitleEl.value.trim().length > 0;
    const hasContent = postContentEl.value.trim().length > 0;
    const isSignedIn = auth.currentUser && !auth.currentUser.isAnonymous;
    createPostBtn.disabled = !(hasTitle && hasContent && isSignedIn);
  }

  // --- AUTH + PRESENCE + CREATE POST BUTTON CONTROL =====
  const initAuth = async () => {
    try {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    } catch (error) {
      console.error("Authentication failed:", error);
    }
  };
  
  onAuthStateChanged(auth, (user) => {
    if (user && !user.isAnonymous) {
      // User is signed in
      userEmailEl.textContent = user.email;
      signInBtn.classList.add("hidden");
      signOutBtn.classList.remove("hidden");
      createPostSection.classList.remove('hidden');
      loginPromptSection.classList.add('hidden');
      trackPresence(user);
      updateTotalMembers();
    } else {
      // User is signed out or anonymous
      userEmailEl.textContent = "";
      signInBtn.classList.remove("hidden");
      signOutBtn.classList.add("hidden");
      createPostSection.classList.add('hidden');
      loginPromptSection.classList.remove('hidden');
    }
    validatePostForm();
  });

  const handleSignIn = async () => {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        // Save or update user doc in Firestore
        await setDoc(doc(db, usersPath, user.uid), {
            email: user.email,
            displayName: user.displayName || "",
            role: "member",
            banned: false,
            lastLogin: serverTimestamp()
        }, { merge: true });
    } catch (error) {
        console.error("Sign-in error:", error);
    }
  };

  signInBtn.addEventListener("click", handleSignIn);
  promptSignInBtn.addEventListener("click", handleSignIn);
  signOutBtn.addEventListener("click", () => signOut(auth));

  postTitleEl.addEventListener("input", validatePostForm);
  postContentEl.addEventListener("input", validatePostForm);

  function trackPresence(user) {
    if (!user) return;
    const userStatusRef = ref(rtdb, `${statusPath}/${user.uid}`);
    
    const isOfflineForDatabase = {
      state: 'offline',
      last_changed: dbServerTimestamp(),
    };

    const isOnlineForDatabase = {
      state: 'online',
      last_changed: dbServerTimestamp(),
      email: user.email
    };

    onValue(ref(rtdb, '.info/connected'), (snapshot) => {
      if (snapshot.val() === false) {
        return;
      }
      onDisconnect(userStatusRef).set(isOfflineForDatabase).then(() => {
        set(userStatusRef, isOnlineForDatabase);
      });
    });
  }

  // Listen for online user count
  onValue(ref(rtdb, statusPath), (snapshot) => {
      if (snapshot.exists()){
          const statuses = snapshot.val();
          const onlineCount = Object.values(statuses).filter(s => s.state === 'online').length;
          onlineVisitorsEl.textContent = onlineCount;
      } else {
          onlineVisitorsEl.textContent = 0;
      }
  });


  // --- Firestore ---
  async function updateTotalMembers() {
    const usersCollection = collection(db, usersPath);
    const snapshot = await getDocs(usersCollection);
    totalMembersEl.textContent = snapshot.size;
  }
  
  createPostBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) return;

    const title = postTitleEl.value.trim();
    const content = postContentEl.value.trim();

    if (!title || !content) {
      alert("Please enter a title and content.");
      return;
    }

    createPostBtn.disabled = true;
    createPostBtn.textContent = "Posting...";

    try {
      await addDoc(collection(db, postsPath), {
        title,
        content,
        authorId: user.uid,
        authorEmail: user.email,
        createdAt: serverTimestamp(),
      });
      postTitleEl.value = '';
      postContentEl.value = '';
    } catch (error) {
      console.error("Error creating post:", error);
      alert("Failed to create post. Please try again.");
    } finally {
      createPostBtn.textContent = "Create Post";
      validatePostForm();
    }
  });

  // Real-time post list
  const q = query(collection(db, postsPath), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
        postListEl.innerHTML = '<div class="text-center text-gray-500 py-10">No posts yet. Be the first to post!</div>';
        return;
    }
    postListEl.innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const postDiv = document.createElement('div');
      postDiv.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer';
      postDiv.setAttribute('data-id', docSnap.id);

      const postDate = data.createdAt?.toDate().toLocaleString() || 'Just now';

      postDiv.innerHTML = `
        <h3 class="text-lg font-bold text-gray-900">${data.title || 'Untitled Post'}</h3>
        <p class="text-sm text-gray-500 mb-2">By ${data.authorEmail || 'Unknown'} on ${postDate}</p>
        <p class="text-gray-700">${(data.content || '').slice(0, 150)}...</p>
      `;
      postDiv.addEventListener('click', () => openPostModal(docSnap.id));
      postListEl.appendChild(postDiv);
    });
  }, (error) => {
      console.error("Error fetching posts:", error);
      postListEl.innerHTML = '<div class="text-center text-red-500 py-10">Error loading posts. Please check permissions and try again.</div>';
  });

  // --- Modal Logic ---
  function openPostModal(postId) {
    modalTitle.textContent = 'Loading...';
    modalBody.innerHTML = '<p>Loading content...</p>';
    modal.classList.remove('hidden');

    if (currentUnsubscribePost) currentUnsubscribePost();
    
    const docRef = doc(db, postsPath, postId);
    currentUnsubscribePost = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        modalTitle.textContent = data.title || 'Untitled Post';
        const postDate = data.createdAt?.toDate().toLocaleString() || 'Just now';
        modalBody.innerHTML = `
          <p class="text-sm text-gray-500 mb-4">By ${data.authorEmail || 'Unknown'} on ${postDate}</p>
          <div class="prose-p:mb-4 prose-headings:font-bold">${data.content.replace(/\n/g, '<br>')}</div>
        `;
      } else {
        modalTitle.textContent = 'Error';
        modalBody.innerHTML = '<p>Post not found. It may have been deleted.</p>';
      }
    }, (error) => {
        console.error("Error fetching post details:", error);
        modalTitle.textContent = 'Error';
        modalBody.innerHTML = '<p>Could not load post. Please try again later.</p>';
    });
  }

  function closeModal() {
    modal.classList.add('hidden');
    if (currentUnsubscribePost) {
      currentUnsubscribePost();
      currentUnsubscribePost = null;
    }
  }

  closeModalBtns.forEach(btn => btn.addEventListener('click', closeModal));
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });

  // --- Initial Load ---
  initAuth();

</script>

</body>
</html>

