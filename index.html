<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Forum</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f5f5f5;
    }
    header {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    header .auth-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #signInBtn {
      background-color: #4285F4;
      color: white;
    }
    #signOutBtn {
      background-color: #d9534f;
      color: white;
    }
    main {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 15px;
    }
    section {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 80px;
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    #createPostBtn {
      background-color: #28a745;
      color: white;
      margin-top: 10px;
    }
    .post {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .stats {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #ddd;
    }
  </style>
</head>
<body>

<header>
  <h1>Community Forum</h1>
  <div class="auth-controls">
    <span id="userEmail"></span>
    <button id="signInBtn">Sign in with Google</button>
    <button id="signOutBtn" style="display:none;">Sign out</button>
  </div>
  <div class="stats">
    <span id="totalMembers">0</span> Total Members |
    <span id="onlineVisitors">0</span> Online Visitors
  </div>
</header>

<main>
  <section>
    <h2>Create a New Post</h2>
    <textarea id="postContent" placeholder="Write something..."></textarea><br>
    <button id="createPostBtn" disabled>Create Post</button>
  </section>

  <section>
    <h2>Posts</h2>
    <div id="postList"></div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, getDocs 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import {
    getDatabase, ref, onDisconnect, set, onValue
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
    authDomain: "forum-3dec5.firebaseapp.com",
    projectId: "forum-3dec5",
    storageBucket: "forum-3dec5.appspot.com",
    messagingSenderId: "519284298976",
    appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
    measurementId: "G-SXS8FRTT03",
    databaseURL: "https://forum-3dec5-default-rtdb.firebaseio.com"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);
  const provider = new GoogleAuthProvider();

  const signInBtn = document.getElementById("signInBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const userEmailEl = document.getElementById("userEmail");
  const createPostBtn = document.getElementById("createPostBtn");
  const postContentEl = document.getElementById("postContent");
  const postListEl = document.getElementById("postList");
  const totalMembersEl = document.getElementById("totalMembers");
  const onlineVisitorsEl = document.getElementById("onlineVisitors");

  // Sign in with Google
  signInBtn.addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      console.error("Sign-in error:", err);
      alert("Sign-in failed. Check console for details.");
    }
  });

  // Sign out
  signOutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Track total members
  async function updateTotalMembers() {
    const snapshot = await getDocs(collection(db, "users"));
    totalMembersEl.textContent = snapshot.size;
  }

  // Track online visitors
  function trackPresence(user) {
    const myRef = ref(rtdb, "onlineUsers/" + user.uid);
    set(myRef, { email: user.email || "Guest", lastActive: Date.now() });
    onDisconnect(myRef).remove();
  }

  onValue(ref(rtdb, "onlineUsers"), (snapshot) => {
    if (snapshot.exists()) {
      onlineVisitorsEl.textContent = Object.keys(snapshot.val()).length;
    } else {
      onlineVisitorsEl.textContent = 0;
    }
  });

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userEmailEl.textContent = user.email;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
      createPostBtn.disabled = false;
      trackPresence(user);
      updateTotalMembers();
    } else {
      userEmailEl.textContent = "";
      signInBtn.style.display = "inline-block";
      signOutBtn.style.display = "none";
      createPostBtn.disabled = true;
    }
  });

  // Create post
  createPostBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
      alert("Please sign in first.");
      return;
    }
    const content = postContentEl.value.trim();
    if (content.length === 0 || content.length > 2000) {
      alert("Post must be between 1 and 2000 characters.");
      return;
    }
    const post = {
      content,
      authorId: user.uid,
      authorEmail: user.email || "",
      createdAt: serverTimestamp(),
      likes: [],
      comments: []
    };
    try {
      await addDoc(collection(db, "posts"), post);
      postContentEl.value = "";
    } catch (err) {
      console.error("Error adding document:", err);
      alert("Could not create post. Check console for details.");
    }
  });

  // Load posts in real-time
  const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  onSnapshot(postsQuery, (snapshot) => {
    postListEl.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<strong>${data.authorEmail}</strong><br>${data.content}`;
      postListEl.appendChild(div);
    });
  });
</script>

</body>
</html>
