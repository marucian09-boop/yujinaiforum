<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for a cleaner look */
    .modal-content::-webkit-scrollbar { width: 8px; }
    .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Base badge style */
    .role-badge {
      display: inline-block;
      padding: 2px 8px;
      margin-left: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      border-radius: 12px;
      color: white;
    }

    /* Admin: animated gradient */
    .role-badge.admin {
      background: linear-gradient(270deg, #ff4d4d, #ffcc00, #4dff4d, #4dd2ff, #b84dff);
      background-size: 1000% 1000%;
      animation: gradientShift 5s ease infinite;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Contributor: glowing green */
    .role-badge.contributor {
      background-color: #28a745;
      box-shadow: 0 0 8px #28a745, 0 0 16px #28a745;
    }

    /* Newbie: solid blue */
    .role-badge.newbie {
      background-color: #007bff;
    }
  </style>
</head>
<body class="h-full font-sans bg-gray-100 text-gray-800">

<div id="app" class="flex flex-col h-full">
  <!-- Header -->
  <header class="bg-white shadow-md w-full sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <h1 class="text-2xl font-bold text-gray-900">Community Forum</h1>
        <div class="flex items-center space-x-4">
          <div id="auth-container" class="flex items-center space-x-3">
            <span id="userEmail" class="text-sm font-medium text-gray-600 hidden sm:block"></span>
            <span id="roleBadge"></span> <!-- Badge will appear here -->
            <button id="signInBtn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
              Sign In
            </button>
            <button id="signOutBtn" class="hidden px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
              Sign Out
            </button>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-200 py-2 text-xs text-gray-500 flex items-center justify-center sm:justify-start space-x-4">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.282-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.282.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span id="totalMembers">0</span>&nbsp;Total Members
        </div>
        <div class="flex items-center">
             <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span id="onlineVisitors">0</span>&nbsp;Online
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-4xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Create Post Section -->
    <section id="create-post-section" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
      <h2 class="text-xl font-bold mb-4">Create a New Post</h2>
      <input type="text" id="postTitle" placeholder="Post Title" maxlength="120" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition mb-4">
      <textarea id="postContent" placeholder="Write something..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition h-32 resize-none"></textarea>
      <button id="createPostBtn" disabled class="mt-4 w-full sm:w-auto px-6 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
        Create Post
      </button>
    </section>

    <!-- Authentication Section -->
    <section id="authSection" class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-bold mb-4 text-center">Create Account or Sign In</h2>
        <div class="space-y-4">
            <input type="text" id="signupUsername" placeholder="Username" maxlength="20" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <button id="signupBtn" class="w-full px-6 py-2 text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition font-semibold">Sign Up with Email</button>
        </div>
        <div class="my-4 flex items-center">
            <hr class="w-full border-gray-300">
            <h3 class="px-2 text-gray-500 font-semibold">Or</h3>
            <hr class="w-full border-gray-300">
        </div>
        <button id="googleSignInBtn" class="w-full flex items-center justify-center px-6 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-76.3 64.5C308.6 102.3 282.7 92 248.3 92c-82.8 0-150.5 66.6-150.5 148.4s67.7 148.4 150.5 148.4c97.2 0 130.3-72.9 135.2-109.2H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path></svg>
            Sign in with Google
        </button>
    </section>

    <!-- Posts Section -->
    <section>
      <h2 class="text-2xl font-bold mb-4">Posts</h2>
      <div id="postList" class="space-y-4">
        <!-- Posts will be dynamically inserted here -->
         <div class="text-center text-gray-500 py-10">Loading posts...</div>
      </div>
    </section>
  </main>
</div>

<!-- Modal -->
<div id="postModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-bold">Loading...</h2>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600 transition">&times;</button>
    </div>
    <div id="modalBody" class="p-6 overflow-y-auto modal-content prose max-w-none">
      <p>Loading content...</p>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, createUserWithEmailAndPassword, updateProfile, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getDatabase, ref, onDisconnect, set, onValue, serverTimestamp as dbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  // --- Firebase Configuration ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const rtdbAppId = appId.replace(/\./g, '_'); // Sanitize for Realtime Database paths
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  
  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);
  const provider = new GoogleAuthProvider();

  // --- DOM Elements ---
  const signInBtn = document.getElementById("signInBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const userEmailEl = document.getElementById("userEmail");
  const createPostBtn = document.getElementById("createPostBtn");
  const postTitleEl = document.getElementById("postTitle");
  const postContentEl = document.getElementById("postContent");
  const postListEl = document.getElementById("postList");
  const totalMembersEl = document.getElementById("totalMembers");
  const onlineVisitorsEl = document.getElementById("onlineVisitors");
  const createPostSection = document.getElementById('create-post-section');
  const authSection = document.getElementById('authSection');
  const modal = document.getElementById('postModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const closeModalBtns = document.querySelectorAll('.close-modal-btn');
  const roleBadgeEl = document.getElementById("roleBadge");
  const signupUsernameEl = document.getElementById("signupUsername");
  const signupEmailEl = document.getElementById("signupEmail");
  const signupPasswordEl = document.getElementById("signupPassword");
  const signupBtn = document.getElementById("signupBtn");
  const googleSignInBtn = document.getElementById("googleSignInBtn");


  // --- Paths ---
  const usersPath = `artifacts/${appId}/public/data/users`;
  const postsPath = `artifacts/${appId}/public/data/posts`;
  const statusPath = `artifacts/${rtdbAppId}/public/data/status`;

  let currentUnsubscribePost = null;

  // --- UI Functions ---
  function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-[100] transition-transform transform translate-x-full ${isError ? 'bg-red-500' : 'bg-green-500'}`;
    document.body.appendChild(notification);
    
    requestAnimationFrame(() => {
        notification.classList.remove('translate-x-full');
    });

    setTimeout(() => {
        notification.classList.add('translate-x-full');
        notification.addEventListener('transitionend', () => notification.remove());
    }, 3000);
  }

  function validatePostForm() {
    const hasTitle = postTitleEl.value.trim().length > 0;
    const hasContent = postContentEl.value.trim().length > 0;
    const isSignedIn = auth.currentUser && !auth.currentUser.isAnonymous;
    createPostBtn.disabled = !(hasTitle && hasContent && isSignedIn);
  }

  function updateRoleBadge(role) {
    roleBadgeEl.className = "role-badge"; // reset classes
    if (role === "admin") {
      roleBadgeEl.textContent = "ADMIN";
      roleBadgeEl.classList.add("admin");
    } else if (role === "contributor") {
      roleBadgeEl.textContent = "CONTRIBUTOR";
      roleBadgeEl.classList.add("contributor");
    } else {
      roleBadgeEl.textContent = "NEWBIE";
      roleBadgeEl.classList.add("newbie");
    }
  }

  // --- AUTH ---
  const initAuth = async () => {
    try {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    } catch (error) {
      console.error("Authentication failed:", error);
    }
  };
  
  onAuthStateChanged(auth, async (user) => {
    if (user && !user.isAnonymous) {
      // User is signed in
      userEmailEl.textContent = user.displayName || user.email;
      signInBtn.classList.add("hidden");
      signOutBtn.classList.remove("hidden");
      createPostSection.classList.remove('hidden');
      authSection.classList.add('hidden');
      trackPresence(user);
      updateTotalMembers();

      const userDoc = await getDoc(doc(db, usersPath, user.uid));
      if (userDoc.exists()) {
        const role = userDoc.data().role || "newbie";
        updateRoleBadge(role);
      } else {
        updateRoleBadge("newbie");
      }

    } else {
      // User is signed out or anonymous
      userEmailEl.textContent = "";
      roleBadgeEl.innerHTML = "";
      roleBadgeEl.className = "";
      signInBtn.classList.remove("hidden");
      signOutBtn.classList.add("hidden");
      createPostSection.classList.add('hidden');
      authSection.classList.remove('hidden');
    }
    validatePostForm();
  });

  function isStrongPassword(pw) {
    const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/;
    return regex.test(pw);
  }

  signupBtn.addEventListener("click", async () => {
    const username = signupUsernameEl.value.trim();
    const email = signupEmailEl.value.trim();
    const password = signupPasswordEl.value;

    if (!username) return showNotification("Please enter a username.", true);
    if (!email) return showNotification("Please enter an email.", true);
    if (!isStrongPassword(password)) {
      return showNotification("Password must be at least 8 characters, include uppercase, lowercase, number, and special character.", true);
    }

    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCred.user, { displayName: username });

      await setDoc(doc(db, usersPath, userCred.user.uid), {
        email,
        displayName: username,
        role: "newbie",
        banned: false,
        lastLogin: serverTimestamp()
      });
      showNotification("Account created successfully!");
    } catch (err) {
      console.error(err);
      showNotification(err.message, true);
    }
  });

  googleSignInBtn.addEventListener("click", async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      const role = (user.email === "yujinbussinessmatter@gmail.com") ? "admin" : "newbie";

      await setDoc(doc(db, usersPath, user.uid), {
        email: user.email,
        displayName: user.displayName || "",
        role,
        banned: false,
        lastLogin: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error(err);
      showNotification(err.message, true);
    }
  });

  signInBtn.addEventListener('click', () => {
    authSection.scrollIntoView({ behavior: 'smooth' });
  });

  signOutBtn.addEventListener("click", () => signOut(auth));

  // --- Presence ---
  function trackPresence(user) {
    if (!user) return;
    const userStatusRef = ref(rtdb, `${statusPath}/${user.uid}`);
    const isOfflineForDatabase = { state: 'offline', last_changed: dbServerTimestamp() };
    const isOnlineForDatabase = { state: 'online', last_changed: dbServerTimestamp(), email: user.email };

    onValue(ref(rtdb, '.info/connected'), (snapshot) => {
      if (snapshot.val() === false) return;
      onDisconnect(userStatusRef).set(isOfflineForDatabase).then(() => {
        set(userStatusRef, isOnlineForDatabase);
      });
    });
  }

  onValue(ref(rtdb, statusPath), (snapshot) => {
      if (snapshot.exists()){
          const statuses = snapshot.val();
          const onlineCount = Object.values(statuses).filter(s => s.state === 'online').length;
          onlineVisitorsEl.textContent = onlineCount;
      } else {
          onlineVisitorsEl.textContent = 0;
      }
  });


  // --- Firestore ---
  async function updateTotalMembers() {
    const usersCollection = collection(db, usersPath);
    const snapshot = await getDocs(usersCollection);
    totalMembersEl.textContent = snapshot.size;
  }
  
  postTitleEl.addEventListener("input", validatePostForm);
  postContentEl.addEventListener("input", validatePostForm);

  createPostBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) return;
    const title = postTitleEl.value.trim();
    const content = postContentEl.value.trim();
    if (!title || !content) return showNotification("Please enter a title and content.", true);

    createPostBtn.disabled = true;
    createPostBtn.textContent = "Posting...";

    try {
      await addDoc(collection(db, postsPath), {
        title, content, authorId: user.uid, authorEmail: user.email, createdAt: serverTimestamp(),
      });
      postTitleEl.value = '';
      postContentEl.value = '';
    } catch (error) {
      console.error("Error creating post:", error);
      showNotification("Failed to create post. Please try again.", true);
    } finally {
      createPostBtn.textContent = "Create Post";
      validatePostForm();
    }
  });

  // Real-time post list
  const q = query(collection(db, postsPath), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
        postListEl.innerHTML = '<div class="text-center text-gray-500 py-10">No posts yet. Be the first to post!</div>';
        return;
    }
    postListEl.innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const postDiv = document.createElement('div');
      postDiv.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer';
      postDiv.setAttribute('data-id', docSnap.id);
      const postDate = data.createdAt?.toDate().toLocaleString() || 'Just now';
      postDiv.innerHTML = `
        <h3 class="text-lg font-bold text-gray-900">${data.title || 'Untitled Post'}</h3>
        <p class="text-sm text-gray-500 mb-2">By ${data.authorEmail || 'Unknown'} on ${postDate}</p>
        <p class="text-gray-700">${(data.content || '').slice(0, 150)}...</p>`;
      postDiv.addEventListener('click', () => openPostModal(docSnap.id));
      postListEl.appendChild(postDiv);
    });
  }, (error) => {
      console.error("Error fetching posts:", error);
      postListEl.innerHTML = '<div class="text-center text-red-500 py-10">Error loading posts. Please check permissions and try again.</div>';
  });

  // --- Modal Logic ---
  function openPostModal(postId) {
    modalTitle.textContent = 'Loading...';
    modalBody.innerHTML = '<p>Loading content...</p>';
    modal.classList.remove('hidden');

    if (currentUnsubscribePost) currentUnsubscribePost();
    
    const docRef = doc(db, postsPath, postId);
    currentUnsubscribePost = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        modalTitle.textContent = data.title || 'Untitled Post';
        const postDate = data.createdAt?.toDate().toLocaleString() || 'Just now';
        modalBody.innerHTML = `
          <p class="text-sm text-gray-500 mb-4">By ${data.authorEmail || 'Unknown'} on ${postDate}</p>
          <div class="prose-p:mb-4 prose-headings:font-bold">${data.content.replace(/\n/g, '<br>')}</div>`;
      } else {
        modalTitle.textContent = 'Error';
        modalBody.innerHTML = '<p>Post not found. It may have been deleted.</p>';
      }
    }, (error) => {
        console.error("Error fetching post details:", error);
        modalTitle.textContent = 'Error';
        modalBody.innerHTML = '<p>Could not load post. Please try again later.</p>';
    });
  }

  function closeModal() {
    modal.classList.add('hidden');
    if (currentUnsubscribePost) {
      currentUnsubscribePost();
      currentUnsubscribePost = null;
    }
  }

  closeModalBtns.forEach(btn => btn.addEventListener('click', closeModal));
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });

  // --- Initial Load ---
  initAuth();

</script>

</body>
</html>

