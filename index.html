<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for a cleaner look */
    .modal-content::-webkit-scrollbar, .messages::-webkit-scrollbar, .threads-list::-webkit-scrollbar { width: 8px; }
    .modal-content::-webkit-scrollbar-track, .messages::-webkit-scrollbar-track, .threads-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb, .messages::-webkit-scrollbar-thumb, .threads-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .modal-content::-webkit-scrollbar-thumb:hover, .messages::-webkit-scrollbar-thumb:hover, .threads-list::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Base badge style */
    .role-badge { display: inline-block; padding: 2px 8px; margin-left: 6px; font-size: 0.8rem; font-weight: bold; border-radius: 12px; color: white; }
    .role-badge.admin { background: linear-gradient(270deg, #ff4d4d, #ffcc00, #4dff4d, #4dd2ff, #b84dff); background-size: 1000% 1000%; animation: gradientShift 5s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .role-badge.contributor { background-color: #28a745; box-shadow: 0 0 8px #28a745, 0 0 16px #28a745; }
    .role-badge.newbie { background-color: #007bff; }
    [contenteditable=true]:empty:before { content: attr(placeholder); pointer-events: none; display: block; color: #9ca3af; }

    /* New Inbox styles */
    .inbox.hidden { display: none; }
    .inbox { background:#fff; border-radius:6px; margin-top:20px; overflow:hidden; border:1px solid #e5e5e5; }
    .inbox-wrap { display:flex; min-height:420px; max-height:70vh; }
    .inbox-sidebar { width:320px; min-width:260px; border-right:1px solid #eee; background:#fafafa; display:flex; flex-direction:column; position: relative; }
    .inbox-search { padding:10px; border-bottom:1px solid #eee; }
    .inbox-search input { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:6px; font-size:14px; }
    #inboxSearchResults { position: absolute; top: 60px; left: 10px; right: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; z-index: 10; max-height: 200px; overflow-y: auto; }
    .threads-list { list-style:none; margin:0; padding:0; overflow:auto; }
    .thread-item { display:flex; gap:10px; padding:10px 12px; border-bottom:1px solid #f1f1f1; cursor:pointer; align-items:center; }
    .thread-item:hover, .thread-item.active { background:#f3f6ff; }
    .thread-avatar { width:36px; height:36px; border-radius:50%; background:#6f42c1; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; flex-shrink: 0; }
    .thread-main { flex:1; min-width:0; }
    .thread-top { display:flex; justify-content:space-between; gap:8px; }
    .thread-name { font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .thread-time { font-size:12px; color:#888; white-space:nowrap; }
    .thread-preview { font-size:13px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .unread-badge { background:#ff4757; color:#fff; font-size:12px; padding:1px 6px; border-radius:10px; margin-left:6px; }
    .inbox-conversation { flex:1; display:flex; flex-direction:column; }
    .conv-header { display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eee; }
    .back-btn { display:none; background:#eee; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .conv-meta { display:flex; align-items:center; gap:10px; }
    .conv-avatar { width:40px; height:40px; border-radius:50%; background:#6f42c1; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; flex-shrink: 0; }
    .conv-name { font-weight:700; }
    .conv-role-badge { font-size:12px; font-weight:700; display:inline-block; padding:2px 8px; border-radius:12px; color:#fff; }
    .conv-role-badge.admin { background: linear-gradient(270deg, #ff4d4d, #ffcc00, #4dff4d, #4dd2ff, #b84dff); background-size: 1000% 1000%; animation: gradientShift 5s ease infinite; }
    .conv-role-badge.contributor { background:#28a745; box-shadow:0 0 8px #28a745, 0 0 16px #28a745; }
    .conv-role-badge.newbie { background:#007bff; }
    .messages { flex:1; padding:14px; overflow:auto; background:#f8fafc; }
    .msg { max-width:72%; margin-bottom:10px; padding:8px 10px; border-radius:10px; line-height:1.35; font-size:14px; word-wrap:break-word; }
    .msg .time { display:block; margin-top:4px; font-size:11px; opacity:.7; }
    .msg.in { background:#fff; border:1px solid #eee; }
    .msg.out { margin-left:auto; background:#6f42c1; color:#fff; }
    .msg.out .time { color:rgba(255,255,255,.85); }
    .composer { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:#fff; }
    .composer textarea { flex:1; resize:none; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:14px; max-height:120px; }
    .send-btn { background:#6f42c1; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; }
    .send-btn:disabled { opacity:.6; cursor:not-allowed; }
    
    @media (max-width: 860px) {
        .inbox-sidebar { display: block; width:100%; min-width:unset; }
        .inbox-conversation.active-thread { display: flex; }
        .inbox-conversation { display: none; }
        .inbox-sidebar.thread-selected { display: none; }
        .back-btn { display:inline-block; }
    }
  </style>
</head>
<body class="h-full font-sans bg-gray-100 text-gray-800">

<div id="app" class="flex flex-col h-full">
  <!-- Header -->
  <header class="bg-white shadow-md w-full sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-3">
        <h1 class="text-2xl font-bold text-gray-900">Community Forum</h1>
        <div class="flex items-center space-x-4">
          <div id="auth-container" class="flex items-center space-x-3">
            <span id="userEmail" class="text-sm font-medium text-gray-600 hidden sm:block cursor-pointer hover:underline"></span>
            <span id="roleBadge"></span>
            <button id="signInBtn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
              Sign In
            </button>
            <button id="openInboxBtn" class="hidden px-4 py-2 text-sm font-semibold text-white bg-purple-600 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition">Inbox</button>
            <button id="signOutBtn" class="hidden px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
              Sign Out
            </button>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-200 py-2 text-xs text-gray-500 flex items-center justify-center sm:justify-start space-x-4">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.282-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.282.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span id="totalMembers">0</span>&nbsp;Total Members
        </div>
        <div class="flex items-center">
             <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span id="onlineVisitors">0</span>&nbsp;Online
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-4xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <section id="createPostSection" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
      <h2 class="text-xl font-bold mb-4">Create a New Post</h2>
      <input type="text" id="postTitle" placeholder="Post Title" maxlength="120" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition mb-4">
      <textarea id="postContent" placeholder="Write something..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition h-32 resize-none"></textarea>
      <button id="createPostBtn" disabled class="mt-4 w-full sm:w-auto px-6 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
        Create Post
      </button>
    </section>
    <section id="loggedOutPrompt" class="bg-white p-6 rounded-lg shadow-md mb-8 text-center">
        <h2 class="text-xl font-bold mb-2">Join the Conversation!</h2>
        <p class="text-gray-600 mb-4">Please sign in to create new posts and engage with the community.</p>
    </section>
    <section>
      <h2 class="text-2xl font-bold mb-4">Posts</h2>
      <div id="postList" class="space-y-4">
         <div class="text-center text-gray-500 py-10">Loading posts...</div>
      </div>
    </section>

    <!-- New Inbox Panel -->
    <section id="inbox" class="inbox hidden">
        <div class="inbox-wrap">
            <aside id="inboxSidebar" class="inbox-sidebar">
                <div class="inbox-search">
                    <input id="inboxSearch" type="text" placeholder="Search or start new chat...">
                    <div id="inboxSearchResults" class="hidden"></div>
                </div>
                <ul id="threadsList" class="threads-list"></ul>
            </aside>
            <section id="inboxConversation" class="inbox-conversation">
                <header class="conv-header">
                    <button id="inboxBackBtn" class="back-btn" aria-label="Back">←</button>
                    <div class="conv-meta">
                        <div class="conv-avatar" id="convAvatar">?</div>
                        <div class="conv-texts">
                            <div id="convName" class="conv-name">Select a conversation</div>
                            <div id="convRole" class="conv-role-badge">—</div>
                        </div>
                    </div>
                </header>
                <div id="messagesContainer" class="messages"><div class="p-4 text-center text-gray-500">Please select a conversation to start messaging.</div></div>
                <footer class="composer">
                    <textarea id="messageInput" placeholder="Write a message..." rows="1"></textarea>
                    <button id="sendMessageBtn" class="send-btn" disabled>Send</button>
                </footer>
            </section>
        </div>
    </section>
  </main>
</div>

<!-- Modals (kept for other features) -->
<div id="postModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-bold">Loading...</h2>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600 transition text-2xl">&times;</button>
    </div>
    <div id="modalBody" class="p-6 overflow-y-auto modal-content prose max-w-none"></div>
  </div>
</div>
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-md relative">
        <button class="close-modal-btn absolute top-3 right-4 text-gray-400 hover:text-gray-600 transition text-2xl">&times;</button>
        <div class="border-b">
            <nav class="flex -mb-px">
                <button id="signInTab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-blue-500 text-blue-600">Sign In</button>
                <button id="signUpTab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Sign Up</button>
            </nav>
        </div>
        <div id="signInForm" class="p-6"><div class="space-y-4">
                <input type="email" id="signInEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <input type="password" id="signInPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="signInEmailBtn" class="w-full px-6 py-2 text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition font-semibold">Sign In</button>
        </div></div>
        <div id="signUpForm" class="p-6 hidden"><div class="space-y-4">
                <input type="text" id="signUpUsername" placeholder="Username" maxlength="20" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <input type="email" id="signUpEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <input type="password" id="signUpPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="signUpBtn" class="w-full px-6 py-2 text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition font-semibold">Create Account</button>
        </div></div>
        <div class="px-6 pb-6"><div class="my-4 flex items-center"><hr class="w-full border-gray-300"><h3 class="px-2 text-gray-500 font-semibold text-sm">Or</h3><hr class="w-full border-gray-300"></div>
            <button id="googleSignInBtn" class="w-full flex items-center justify-center px-6 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-76.3 64.5C308.6 102.3 282.7 92 248.3 92c-82.8 0-150.5 66.6-150.5 148.4s67.7 148.4 150.5 148.4c97.2 0 130.3-72.9 135.2-109.2H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>
</div>
<div id="userProfileModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-bold">User Profile</h3>
            <button class="close-modal-btn text-2xl font-light">&times;</button>
        </div>
        <div class="space-y-4">
            <p>Total Posts: <span id="profilePostCount" class="font-bold">0</span></p>
            <div id="changeUsernameSection" style="display: none;">
                <label for="newUsernameInput" class="block text-sm font-medium">Change Username</label>
                <div class="flex mt-1">
                    <input type="text" id="newUsernameInput" placeholder="New username" class="w-full px-3 py-2 border rounded-l-md">
                    <button id="changeUsernameBtn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-r-md hover:bg-blue-700">Save</button>
                </div>
                 <p id="changeUsernameError" class="text-xs text-red-500 mt-1" style="display: none;"></p>
            </div>
            <button id="closeAccountBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Close My Account</button>
        </div>
    </div>
</div>
<div id="adminModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold mb-2">Manage User</h3>
            <button class="close-modal-btn text-2xl font-light">&times;</button>
        </div>
        <p id="adminModalUsername" class="text-sm font-medium text-blue-600 mb-4"></p>
        <div class="space-y-4">
            <div><label class="block text-sm font-medium">Send Warning</label>
            <textarea id="warningMessage" placeholder="Enter warning message..." class="mt-1 w-full p-2 h-24 border rounded-md"></textarea>
            <button id="sendWarningBtn" class="mt-2 w-full px-4 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-md hover:bg-yellow-600">Send Warning</button></div>
            <div class="flex space-x-4">
                <button id="banUserBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Ban User</button>
                <button id="unbanUserBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">Unban User</button>
            </div>
        </div>
    </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDocs, setDoc, getDoc, writeBatch, updateDoc, where, arrayUnion, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getDatabase, ref, onDisconnect, set, onValue, serverTimestamp as dbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
    authDomain: "forum-3dec5.firebaseapp.com",
    databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "forum-3dec5",
    storageBucket: "forum-3dec5.appspot.com",
    messagingSenderId: "519284298976",
    appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
    measurementId: "G-SXS8FRTT03"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const rtdb = getDatabase(app);
  const provider = new GoogleAuthProvider();

  // --- DOM Element Selection ---
  const signInBtn = document.getElementById("signInBtn");
  const signOutBtn = document.getElementById("signOutBtn");
  const userEmailEl = document.getElementById("userEmail");
  const createPostBtn = document.getElementById("createPostBtn");
  const postTitleEl = document.getElementById("postTitle");
  const postContentEl = document.getElementById("postContent");
  const postListEl = document.getElementById("postList");
  const totalMembersEl = document.getElementById("totalMembers");
  const onlineVisitorsEl = document.getElementById("onlineVisitors");
  const createPostSection = document.getElementById('createPostSection');
  const loggedOutPrompt = document.getElementById('loggedOutPrompt');
  const roleBadgeEl = document.getElementById("roleBadge");
  
  // Modals
  const postModal = document.getElementById('postModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const authModal = document.getElementById('authModal');
  const userProfileModal = document.getElementById('userProfileModal');
  const adminModal = document.getElementById('adminModal');
  
  // Auth Modal
  const signInTab = document.getElementById('signInTab');
  const signUpTab = document.getElementById('signUpTab');
  const signInForm = document.getElementById('signInForm');
  const signUpForm = document.getElementById('signUpForm');
  const signInEmailEl = document.getElementById('signInEmail');
  const signInPasswordEl = document.getElementById('signInPassword');
  const signInEmailBtn = document.getElementById('signInEmailBtn');
  const signUpUsernameEl = document.getElementById("signUpUsername");
  const signUpEmailEl = document.getElementById("signUpEmail");
  const signUpPasswordEl = document.getElementById("signUpPassword");
  const signUpBtn = document.getElementById("signUpBtn");
  const googleSignInBtn = document.getElementById("googleSignInBtn");

  // User Profile
  const profilePostCount = document.getElementById('profilePostCount');
  const changeUsernameSection = document.getElementById('changeUsernameSection');
  const newUsernameInput = document.getElementById('newUsernameInput');
  const changeUsernameBtn = document.getElementById('changeUsernameBtn');
  const changeUsernameError = document.getElementById('changeUsernameError');
  const closeAccountBtn = document.getElementById('closeAccountBtn');

  // Admin
  const adminModalUsername = document.getElementById('adminModalUsername');
  const warningMessage = document.getElementById('warningMessage');
  const sendWarningBtn = document.getElementById('sendWarningBtn');
  const banUserBtn = document.getElementById('banUserBtn');
  const unbanUserBtn = document.getElementById('unbanUserBtn');
  let targetUserIdForAdmin = null;

  // Inbox Elements
  const openInboxBtn = document.getElementById('openInboxBtn');
  const inboxEl = document.getElementById('inbox');
  const inboxSidebar = document.getElementById('inboxSidebar');
  const inboxConversation = document.getElementById('inboxConversation');
  const inboxSearchEl = document.getElementById('inboxSearch');
  const inboxSearchResults = document.getElementById('inboxSearchResults');
  const threadsListEl = document.getElementById('threadsList');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const sendMessageBtn = document.getElementById('sendMessageBtn');
  const inboxBackBtn = document.getElementById('inboxBackBtn');
  const convNameEl = document.getElementById('convName');
  const convRoleEl = document.getElementById('convRole');
  const convAvatarEl = document.getElementById('convAvatar');

  // --- Paths & State ---
  const usersPath = `users`;
  const postsPath = `posts`;
  const statusPath = `status`;
  const conversationsPath = 'conversations';

  let currentUserData = null;
  let usersDataCache = {};
  let currentUnsubscribePost = null;
  let inboxUnsubscribe = null;
  let messagesUnsubscribe = null;
  let activeThreadId = null;
  let activeRecipient = null; // For new conversations

  // --- Utility Functions ---
  const initials = (name) => name?.split(' ').map(p => p[0]?.toUpperCase()).join('').slice(0,2) || '?';
  const formatTime = (ts) => ts ? new Date(ts.toMillis()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
  function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-[100] transition-transform transform translate-x-full ${isError ? 'bg-red-500' : 'bg-green-500'}`;
    document.body.appendChild(notification);
    requestAnimationFrame(() => { notification.classList.remove('translate-x-full'); });
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        notification.addEventListener('transitionend', () => notification.remove());
    }, 3000);
  }
  
  // --- Main Auth Observer ---
  onAuthStateChanged(auth, async (user) => {
    if (user && !user.isAnonymous) {
      const userDocRef = doc(db, usersPath, user.uid);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) {
          const username = user.displayName || `user-${user.uid.slice(0,5)}`;
          const role = user.email === "yujinbussinessmatter@gmail.com" ? "admin" : "newbie";
          await setDoc(userDocRef, {
              email: user.email, displayName: username, role: role, banned: false, lastLogin: serverTimestamp()
          });
          currentUserData = (await getDoc(userDocRef)).data();
      } else {
          currentUserData = userDocSnap.data();
      }

      userEmailEl.textContent = currentUserData.displayName || user.email;
      signInBtn.classList.add("hidden");
      signOutBtn.classList.remove("hidden");
      openInboxBtn.classList.remove('hidden');
      createPostSection.classList.remove('hidden');
      loggedOutPrompt.classList.add('hidden');
      
      trackPresence(user);
      updateRoleBadge(currentUserData.role || 'newbie');
      
    } else {
      currentUserData = null;
      userEmailEl.textContent = "";
      roleBadgeEl.innerHTML = '';
      signInBtn.classList.remove("hidden");
      signOutBtn.classList.add("hidden");
      openInboxBtn.classList.add('hidden');
      createPostSection.classList.add('hidden');
      loggedOutPrompt.classList.remove('hidden');
      inboxEl.classList.add('hidden');
      if (inboxUnsubscribe) inboxUnsubscribe();
      if (messagesUnsubscribe) messagesUnsubscribe();
      if (!auth.currentUser) signInAnonymously(auth).catch(console.error);
    }
    validatePostForm();
  });
  
  // --- Global Listeners ---
  onSnapshot(query(collection(db, postsPath), orderBy("createdAt", "desc")), (snapshot) => {
    postListEl.innerHTML = snapshot.empty ? '<div class="text-center text-gray-500 py-10">No posts yet.</div>' : '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const postDiv = document.createElement('div');
      postDiv.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition';
      postDiv.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-lg font-bold text-gray-900 cursor-pointer view-post-btn">${data.title || 'Untitled Post'}</h3>
            <p class="text-sm text-gray-500 mb-2">By ${usersDataCache[data.authorId]?.displayName || 'Unknown'} on ${data.createdAt?.toDate().toLocaleString() || ''}</p>
          </div>
          ${currentUserData?.role === 'admin' ? `<button data-author-id="${data.authorId}" class="manage-user-btn p-2 text-gray-400 hover:text-blue-500 rounded-full"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg></button>` : ''}
        </div>
        <p class="text-gray-700 mt-2">${(data.content || '').slice(0, 150)}...</p>`;
      
      postDiv.addEventListener('click', (e) => {
        const manageBtn = e.target.closest('.manage-user-btn');
        const viewBtn = e.target.closest('.view-post-btn');
        if (manageBtn) openAdminModal(manageBtn.dataset.authorId);
        else if (viewBtn) openPostModal(docSnap.id);
      });
      postListEl.appendChild(postDiv);
    });
  });
  
  onSnapshot(collection(db, usersPath), (snapshot) => {
    totalMembersEl.textContent = snapshot.size;
    snapshot.forEach(doc => { usersDataCache[doc.id] = doc.data(); });
  });

  onValue(ref(rtdb, statusPath), (snapshot) => {
    onlineVisitorsEl.textContent = snapshot.exists() ? snapshot.size : 0;
  });

  // --- Inbox Logic ---
  function renderThreads(threads, currentActiveId) {
    threadsListEl.innerHTML = '';
    threads.sort((a,b) => (b.lastMessageTimestamp?.toMillis() || 0) - (a.lastMessageTimestamp?.toMillis() || 0));

    threads.forEach(thread => {
      const otherUserId = thread.participants.find(id => id !== auth.currentUser.uid);
      const otherUser = usersDataCache[otherUserId];
      if (!otherUser) return;

      const isUnread = thread.lastReadBy && !thread.lastReadBy.includes(auth.currentUser.uid) && thread.lastSender !== auth.currentUser.uid;
      const li = document.createElement('li');
      li.className = `thread-item ${thread.id === currentActiveId ? 'active' : ''}`;
      li.dataset.threadId = thread.id;
      li.innerHTML = `
        <div class="thread-avatar">${initials(otherUser.displayName)}</div>
        <div class="thread-main">
          <div class="thread-top">
            <div class="thread-name">${otherUser.displayName}</div>
            <div class="thread-time">${formatTime(thread.lastMessageTimestamp)}</div>
          </div>
          <div class="thread-preview">
            ${thread.lastMessage || '...'}
            ${isUnread ? `<span class="unread-badge">New</span>` : ''}
          </div>
        </div>`;
      li.addEventListener('click', () => setActiveThread(thread.id));
      threadsListEl.appendChild(li);
    });
  }

  function setActiveThread(threadId) {
    if (messagesUnsubscribe) messagesUnsubscribe();
    activeThreadId = threadId;
    activeRecipient = null; 

    const messagesRef = collection(db, conversationsPath, threadId, 'messages');
    const q = query(messagesRef, orderBy('createdAt'));
    
    messagesUnsubscribe = onSnapshot(q, (snapshot) => {
        const threadDocRef = doc(db, conversationsPath, threadId);
        getDoc(threadDocRef).then(threadSnap => {
            const threadData = threadSnap.data();
            const otherUserId = threadData.participants.find(id => id !== auth.currentUser.uid);
            const otherUser = usersDataCache[otherUserId];

            convNameEl.textContent = otherUser.displayName;
            convAvatarEl.textContent = initials(otherUser.displayName);
            convRoleEl.className = 'conv-role-badge ' + (otherUser.role || 'newbie');
            convRoleEl.textContent = (otherUser.role || 'newbie').toUpperCase();
        });

        messagesContainer.innerHTML = '';
        snapshot.forEach(msgDoc => {
            const msg = msgDoc.data();
            const div = document.createElement('div');
            const isOut = msg.senderId === auth.currentUser.uid;
            div.className = `msg ${isOut ? 'out' : 'in'}`;
            div.innerHTML = `<div class="text">${msg.content}</div><span class="time">${formatTime(msg.createdAt)}</span>`;
            messagesContainer.appendChild(div);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        sendMessageBtn.disabled = false;
        
        updateDoc(threadDocRef, { lastReadBy: arrayUnion(auth.currentUser.uid) });
    });

    if (window.innerWidth <= 860) {
        inboxSidebar.classList.add('thread-selected');
        inboxConversation.classList.add('active-thread');
    }
  }

  function startNewConversation(recipient) {
    if (messagesUnsubscribe) messagesUnsubscribe();
    activeThreadId = null;
    activeRecipient = recipient;

    convNameEl.textContent = recipient.displayName;
    convAvatarEl.textContent = initials(recipient.displayName);
    convRoleEl.className = 'conv-role-badge ' + (recipient.role || 'newbie');
    convRoleEl.textContent = (recipient.role || 'newbie').toUpperCase();
    messagesContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Starting a new conversation with ${recipient.displayName}.</div>`;
    sendMessageBtn.disabled = false;

    if (window.innerWidth <= 860) {
        inboxSidebar.classList.add('thread-selected');
        inboxConversation.classList.add('active-thread');
    }
  }
  
  openInboxBtn.addEventListener('click', () => {
    if (!currentUserData) return;
    inboxEl.classList.toggle('hidden');

    if (!inboxEl.classList.contains('hidden')) {
        if (inboxUnsubscribe) inboxUnsubscribe();
        const q = query(collection(db, conversationsPath), where('participants', 'array-contains', auth.currentUser.uid));
        inboxUnsubscribe = onSnapshot(q, (snapshot) => {
            const threads = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            renderThreads(threads, activeThreadId);
        });
    } else {
        if (inboxUnsubscribe) inboxUnsubscribe();
        if (messagesUnsubscribe) messagesUnsubscribe();
        activeThreadId = null;
    }
  });

  sendMessageBtn.addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if (!text || (!activeThreadId && !activeRecipient)) return;
    
    let threadId = activeThreadId;
    if (!threadId) { // Creating a new conversation
        threadId = [auth.currentUser.uid, activeRecipient.id].sort().join('_');
        await setDoc(doc(db, conversationsPath, threadId), {
            participants: [auth.currentUser.uid, activeRecipient.id]
        }, { merge: true });
        setActiveThread(threadId); // Switch to listening to the new thread
    }
    
    const messagesRef = collection(db, conversationsPath, threadId, 'messages');
    await addDoc(messagesRef, { senderId: auth.currentUser.uid, content: text, createdAt: serverTimestamp() });
    await updateDoc(doc(db, conversationsPath, threadId), {
        lastMessage: text, lastMessageTimestamp: serverTimestamp(), lastReadBy: [auth.currentUser.uid], lastSender: auth.currentUser.uid
    });
    messageInput.value = '';
    messageInput.style.height = 'auto';
  });

  inboxSearchEl.addEventListener('input', async (e) => {
    const searchTerm = e.target.value.trim();
    inboxSearchResults.innerHTML = '';
    if (searchTerm.length < 2) {
        inboxSearchResults.classList.add('hidden');
        return;
    }
    const q = query(collection(db, usersPath), where('displayName', '>=', searchTerm), where('displayName', '<=', searchTerm + '\uf8ff'), limit(5));
    const userDocs = await getDocs(q);

    userDocs.forEach(userDoc => {
        if (userDoc.id === auth.currentUser.uid) return;
        const userData = userDoc.data();
        const resultEl = document.createElement('div');
        resultEl.className = 'p-2 hover:bg-gray-100 cursor-pointer';
        resultEl.textContent = userData.displayName;
        resultEl.addEventListener('click', () => {
            startNewConversation({ id: userDoc.id, ...userData });
            inboxSearchEl.value = '';
            inboxSearchResults.classList.add('hidden');
        });
        inboxSearchResults.appendChild(resultEl);
    });
    inboxSearchResults.classList.toggle('hidden', userDocs.empty);
  });
  
  inboxBackBtn.addEventListener('click', () => {
    inboxSidebar.classList.remove('thread-selected');
    inboxConversation.classList.remove('active-thread');
    if (messagesUnsubscribe) messagesUnsubscribe();
    activeThreadId = null;
    activeRecipient = null;
    sendMessageBtn.disabled = true;
  });

  // --- Auth & Account Functions ---
    signInBtn.addEventListener('click', () => authModal.classList.remove('hidden'));
    signOutBtn.addEventListener('click', () => signOut(auth));

    signInTab.addEventListener('click', () => {
        signInForm.classList.remove('hidden'); signUpForm.classList.add('hidden');
        signInTab.classList.add('border-blue-500', 'text-blue-600');
        signUpTab.classList.remove('border-blue-500', 'text-blue-600');
    });
    signUpTab.addEventListener('click', () => {
        signUpForm.classList.remove('hidden'); signInForm.classList.add('hidden');
        signUpTab.classList.add('border-blue-500', 'text-blue-600');
        signInTab.classList.remove('border-blue-500', 'text-blue-600');
    });

    googleSignInBtn.addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, provider);
            authModal.classList.add('hidden');
            showNotification('Signed in with Google successfully!');
        } catch (error) {
            showNotification(error.message, true);
        }
    });

    signInEmailBtn.addEventListener('click', async () => {
        const email = signInEmailEl.value;
        const password = signInPasswordEl.value;
        if (!email || !password) return showNotification('Please enter email and password.', true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
            authModal.classList.add('hidden');
            showNotification('Signed in successfully!');
        } catch (error) {
            showNotification(error.message, true);
        }
    });

    signUpBtn.addEventListener('click', async () => {
        const username = signUpUsernameEl.value.trim();
        const email = signUpEmailEl.value.trim();
        const password = signUpPasswordEl.value;
        if (!username || !email || !password) return showNotification('Please fill all fields.', true);
        
        const userQuery = query(collection(db, usersPath), where("displayName", "==", username));
        if (!(await getDocs(userQuery)).empty) return showNotification("Username is already taken.", true);
        
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged will handle creating the user doc
            authModal.classList.add('hidden');
            showNotification('Account created successfully!');
        } catch (error) {
            showNotification(error.message, true);
        }
    });

  // --- Other Functions ---
  function validatePostForm() {
    const isSignedIn = auth.currentUser && !auth.currentUser.isAnonymous;
    const canPost = isSignedIn && currentUserData && !currentUserData.banned;
    createPostBtn.disabled = !canPost;
  }
  
  function updateRoleBadge(role) {
    roleBadgeEl.className = "role-badge " + (role || 'newbie');
    roleBadgeEl.textContent = (role || 'newbie').toUpperCase();
  }
  
  function trackPresence(user) {
    if (!user) return;
    const myConnectionsRef = ref(rtdb, `${statusPath}/${user.uid}`);
    onValue(ref(rtdb, '.info/connected'), (snap) => {
        if (snap.val() === true) {
            set(myConnectionsRef, { online: true, last_changed: dbServerTimestamp() });
            onDisconnect(myConnectionsRef).remove();
        }
    });
  }

  createPostBtn.addEventListener("click", async () => {
    if (createPostBtn.disabled) return showNotification("You cannot post.", true);
    const title = postTitleEl.value.trim();
    const content = postContentEl.value.trim();
    if (!title || !content) return showNotification("Title and content are required.", true);
    
    await addDoc(collection(db, postsPath), {
      title, content, authorId: auth.currentUser.uid, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), edited: false
    });
    postTitleEl.value = ''; postContentEl.value = '';
    showNotification("Post created!");
  });
  
  // Modals Open/Close
  document.querySelectorAll('.close-modal-btn').forEach(btn => {
      btn.addEventListener('click', (e) => e.target.closest('.fixed').classList.add('hidden'));
  });

  function openPostModal(postId) {
      postModal.classList.remove('hidden');
      if(currentUnsubscribePost) currentUnsubscribePost();
      currentUnsubscribePost = onSnapshot(doc(db, postsPath, postId), (docSnap) => {
          if(docSnap.exists()){
              const data = docSnap.data();
              modalTitle.textContent = data.title;
              modalBody.innerHTML = `<p class="text-sm text-gray-500 mb-4">By ${usersDataCache[data.authorId]?.displayName || 'Unknown'} on ${data.createdAt?.toDate().toLocaleString()}</p><div>${data.content.replace(/\n/g, '<br>')}</div>`;
          }
      });
  } 

  async function openAdminModal(userId) {
      targetUserIdForAdmin = userId;
      const user = usersDataCache[userId];
      if (user) {
          adminModalUsername.textContent = user.displayName;
          adminModal.classList.remove('hidden');
      }
  }
  
  userEmailEl.addEventListener('click', async () => {
    if(!currentUserData) return;
    const postSnap = await getDocs(query(collection(db, postsPath), where("authorId", "==", auth.currentUser.uid)));
    profilePostCount.textContent = postSnap.size;
    changeUsernameSection.style.display = (currentUserData.role === 'admin' || currentUserData.role === 'contributor') ? 'block' : 'none';
    userProfileModal.classList.remove('hidden');
  });

    changeUsernameBtn.addEventListener('click', async () => {
        const newUsername = newUsernameInput.value.trim();
        if (!newUsername) return showNotification("Username cannot be empty.", true);

        const q = query(collection(db, usersPath), where("displayName", "==", newUsername));
        if (!(await getDocs(q)).empty) return showNotification("Username is taken.", true);

        const batch = writeBatch(db);
        batch.update(doc(db, usersPath, auth.currentUser.uid), { displayName: newUsername });
        const postsSnap = await getDocs(query(collection(db, postsPath), where("authorId", "==", auth.currentUser.uid)));
        postsSnap.forEach(postDoc => batch.update(postDoc.ref, { authorEmail: newUsername }));
        await batch.commit();
        showNotification("Username updated!");
        userProfileModal.classList.add('hidden');
    });
  
    closeAccountBtn.addEventListener('click', async () => {
        if (!confirm("Are you sure? This will rename your posts and ban you permanently.")) return;
        const batch = writeBatch(db);
        batch.update(doc(db, usersPath, auth.currentUser.uid), { displayName: "[Deleted User]", banned: true });
        const postsSnap = await getDocs(query(collection(db, postsPath), where("authorId", "==", auth.currentUser.uid)));
        postsSnap.forEach(postDoc => batch.update(postDoc.ref, { authorName: "[Deleted User]" }));
        await batch.commit();
        signOut(auth);
        showNotification("Account closed.");
    });
  
    sendWarningBtn.addEventListener('click', async () => {
        const msg = warningMessage.value.trim();
        if (!targetUserIdForAdmin || !msg) return;
        const threadId = [auth.currentUser.uid, targetUserIdForAdmin].sort().join('_');
        const convoRef = doc(db, conversationsPath, threadId);
        await setDoc(convoRef, { participants: [auth.currentUser.uid, targetUserIdForAdmin] }, { merge: true });
        await addDoc(collection(convoRef, 'messages'), {
            senderId: auth.currentUser.uid, content: `<strong>OFFICIAL WARNING:</strong> ${msg}`, createdAt: serverTimestamp()
        });
        showNotification("Warning sent.");
        adminModal.classList.add('hidden');
    });

    banUserBtn.addEventListener('click', async () => {
        await updateDoc(doc(db, usersPath, targetUserIdForAdmin), {banned: true});
        showNotification("User banned.");
        adminModal.classList.add('hidden');
    });
    unbanUserBtn.addEventListener('click', async () => {
        await updateDoc(doc(db, usersPath, targetUserIdForAdmin), {banned: false});
        showNotification("User unbanned.");
        adminModal.classList.add('hidden');
    });

</script>
</body>
</html>

