<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Forum — Diagnostics Build</title>
  <script>window.tailwind=window.tailwind||{};tailwind.config={darkMode:'class'};</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:'Inter',sans-serif}.modal{display:none}.modal.active{display:flex}</style>
</head>
<body class="min-h-screen bg-black text-gray-100 antialiased">
  <div class="container mx-auto max-w-5xl px-3 sm:px-4 lg:px-6 py-4 sm:py-6">
    <header class="flex flex-col sm:flex-row gap-4 sm:gap-6 justify-between sm:items-center mb-6 sm:mb-8">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-100 truncate">Community Forum</h1>
        <p class="text-gray-400 text-sm sm:text-base">Diagnostics build to surface exact Firebase errors.</p>
      </div>
      <div id="auth-container" class="flex flex-wrap gap-2 sm:gap-3">
        <button id="login-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">Log In</button>
        <button id="signup-btn" class="bg-gray-800 text-gray-100 font-semibold px-4 py-2 rounded-lg hover:bg-gray-700 transition">Sign Up</button>
        <div id="user-info" class="hidden items-center flex-wrap gap-2">
          <p class="font-semibold break-all" id="user-email"></p>
          <button id="logout-btn" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-600 transition">Logout</button>
        </div>
      </div>
    </header>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-6 sm:mb-8">
      <div class="bg-gray-900 border border-gray-700 p-4 sm:p-5 rounded-xl shadow text-center">
        <p class="text-2xl sm:text-3xl font-bold text-blue-400" id="member-count">0</p>
        <p class="text-gray-400 text-sm sm:text-base">Total Members</p>
      </div>
      <div class="bg-gray-900 border border-gray-700 p-4 sm:p-5 rounded-xl shadow text-center">
        <p class="text-2xl sm:text-3xl font-bold text-green-400" id="visitor-count">—</p>
        <p class="text-gray-400 text-sm sm:text-base">Visitors (approx.)</p>
      </div>
    </div>

    <!-- Composer -->
    <div id="create-post-form" class="hidden bg-gray-900 border border-gray-700 p-4 sm:p-6 rounded-xl shadow mb-6 sm:mb-8">
      <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">Create a New Post</h2>
      <textarea id="post-content" class="w-full p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-800 text-gray-100 placeholder:text-gray-400" rows="3" placeholder="What's on your mind?"></textarea>
      <div class="mt-3 sm:mt-4 flex flex-col sm:flex-row gap-2">
        <button id="submit-post-btn" class="bg-blue-500 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition w-full sm:w-auto">Post</button>
      </div>
    </div>

    <main id="posts-container" class="space-y-3 sm:space-y-4"></main>

    <!-- Admin Diagnostics (visible only to ADMIN_EMAIL) -->
    <section id="diag-panel" class="hidden bg-gray-900 border border-gray-700 p-4 sm:p-6 rounded-xl shadow mt-8 sm:mt-10">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg sm:text-xl font-bold">Diagnostics</h2>
        <span class="text-xs bg-gray-800 px-2 py-1 rounded-full text-gray-300">Admin only</span>
      </div>
      <p class="text-sm text-gray-300 mb-3">Click "Run checks" to test Firebase init, read, and write. Paste the output back to me.</p>
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="run-diag" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">Run checks</button>
        <button id="clear-diag" class="bg-gray-800 hover:bg-gray-700 text-gray-100 px-3 py-2 rounded">Clear</button>
      </div>
      <pre id="diag-log" class="whitespace-pre-wrap text-xs sm:text-sm bg-black/40 border border-gray-700 rounded p-3 max-h-80 overflow-auto"></pre>
    </section>
  </div>

  <!-- Simple modal for alerts -->
  <div id="generic-modal" class="modal fixed inset-0 bg-black/70 items-center justify-center p-3 sm:p-4 z-50">
    <div class="bg-gray-900 text-gray-100 rounded-xl shadow-xl p-5 sm:p-6 w-full max-w-[92vw] sm:max-w-sm text-center border border-gray-700">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold mb-3"></h3>
      <p id="modal-message" class="text-gray-300 mb-4"></p>
      <div id="modal-buttons" class="flex justify-center">
        <button id="modal-ok-btn" class="bg-blue-500 text-white px-6 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, setDoc, setLogLevel, getDoc, getDocs, where, limit } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    // ✳️ Use your intended config here (project values must match ONE project)
    const firebaseConfig = {
      apiKey: 'AIzaSyAwym9ZPU9PBJ5Q-EAHbBtdvCqCqwfjZNM', // your rotating key (same project)
      authDomain: 'forum-3dec5.firebaseapp.com',
      projectId: 'forum-3dec5',
      storageBucket: 'forum-3dec5.appspot.com',
      messagingSenderId: '519284298976',
      appId: '1:519284298976:web:8bb5e94a44f202802c2c85',
      measurementId: 'G-SXS8FRTT03'
    };
    const ADMIN_EMAIL = 'yujinbussinessmatter@gmail.com';

    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const userEmailEl = document.getElementById('user-email');
    const createPostForm = document.getElementById('create-post-form');
    const postsContainer = document.getElementById('posts-container');
    const memberCountEl = document.getElementById('member-count');

    const diagPanel = document.getElementById('diag-panel');
    const runDiagBtn = document.getElementById('run-diag');
    const clearDiagBtn = document.getElementById('clear-diag');
    const diagLog = document.getElementById('diag-log');

    const genericModal = document.getElementById('generic-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');

    function showAlert(msg, title='Alert'){
      modalTitle.textContent = title; modalMessage.textContent = msg; genericModal.classList.add('active');
      document.getElementById('modal-ok-btn').onclick = ()=>genericModal.classList.remove('active');
    }

    let auth, db, currentUser;

    async function initializeFirebase(){
      try{
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app); db = getFirestore(app); setLogLevel('debug');
        onAuthStateChanged(auth, async (user)=>{
          currentUser = user || null;
          const isMember = !!user;
          if(isMember){
            loginBtn.classList.add('hidden'); signupBtn.classList.add('hidden');
            userInfo.classList.remove('hidden'); userInfo.classList.add('flex');
            userEmailEl.textContent = user.email || 'Member';
            createPostForm.classList.remove('hidden');
            await setDoc(doc(db,'users',user.uid),{email:user.email||null,updatedAt:serverTimestamp(),createdAt:serverTimestamp()},{merge:true});
          }else{
            loginBtn.classList.remove('hidden'); signupBtn.classList.remove('hidden');
            userInfo.classList.add('hidden'); userInfo.classList.remove('flex');
            userEmailEl.textContent=''; createPostForm.classList.add('hidden');
          }
          // show diag to admin
          diagPanel.classList.toggle('hidden', !(user && user.email===ADMIN_EMAIL));
          fetchPosts(); getMemberCount();
        });
      }catch(e){ console.error('Init error',e); showAlert((e.code||'')+' '+(e.message||'').trim(),'Connection Error'); }
    }

    // Auth modal basics
    loginBtn.addEventListener('click',()=>showAlert('Use your email/password via the normal modal in your production build. This diag build focuses on Firestore checks.'));
    signupBtn.addEventListener('click',()=>showAlert('Sign up via the production build.'));
    logoutBtn.addEventListener('click',()=>signOut(auth).catch(console.error));

    // Posting
    document.getElementById('submit-post-btn').addEventListener('click', async ()=>{
      const content = document.getElementById('post-content').value.trim();
      if(!currentUser) return showAlert('Please log in to post.');
      if(!content) return;
      try{ await addDoc(collection(db,'posts'),{content,authorId:currentUser.uid,authorEmail:currentUser.email||null,createdAt:serverTimestamp(),likes:[],comments:[]});
        document.getElementById('post-content').value='';
      }catch(e){ console.error(e); showAlert(`Could not publish your post.\n\n${e.code||''} ${e.message||''}`.trim()); }
    });

    function fetchPosts(){ const qy=query(collection(db,'posts'),orderBy('createdAt','desc')); onSnapshot(qy,(qs)=>{ postsContainer.innerHTML=''; qs.forEach((d)=>{ const p=d.data(); const div=document.createElement('div'); div.className='bg-gray-900 border border-gray-700 p-4 rounded-xl'; div.innerHTML=`<div class='text-sm text-gray-400'>${p.authorEmail||'Member'}</div><div class='text-gray-100 mt-2 whitespace-pre-wrap'>${(p.content||'')}</div>`; postsContainer.appendChild(div); });}); }
    function getMemberCount(){ onSnapshot(collection(db,'users'),(s)=>{ memberCountEl.textContent=s.size; }); }

    // Diagnostics
    function log(...a){ diagLog.textContent += a.join(' ')+'\n'; }
    clearDiagBtn.onclick = ()=>{ diagLog.textContent=''; };
    runDiagBtn.onclick = async ()=>{
      diagLog.textContent='';
      try { log('SDK projectId:', getApp().options.projectId); } catch(e){ log('No app?',e.message); }
      log('Auth signed in:', !!currentUser, currentUser?.email||'');
      try { await getDocs(query(collection(db,'posts'), limit(1))); log('Firestore READ: OK'); }
      catch(e){ log('Firestore READ error:', e.code, e.message); }
      try { await addDoc(collection(db,'diagnostics'), { by: currentUser?.email||null, ts: new Date() }); log('Firestore WRITE: OK'); }
      catch(e){ log('Firestore WRITE error:', e.code, e.message); }
      log('Done.');
    };

    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
