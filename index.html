<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Forum - Home</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Inter Font */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
        transition: background-color 0.3s, color 0.3s;
    }
    /* Simple fade-in animation for elements */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    /* Toggle switch styles */
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4f46e5; }
    input:checked + .slider:before { transform: translateX(26px); }

    /* Custom styles for dark mode compatibility */
    .dark .bg-gray-100 { background-color: #1f2937; }
    .dark .bg-gray-200 { background-color: #374151; }
    .dark .text-gray-900 { color: #f9fafb; }
    .dark .text-gray-500 { color: #d1d5db; }
    .dark .text-gray-800 { color: #e5e7eb; }
    .dark .border-gray-300 { border-color: #4b5563; }
    .dark .ring-indigo-500 { ring-color: #818cf8; }
    .dark .placeholder-gray-400::placeholder { color: #9ca3af; }

</style>
</head>
<body class="bg-gray-100">

<div id="app-container">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Community Forum</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- User Info Display -->
                    <div id="userInfoContainer" class="flex items-center space-x-2" style="display: none;">
                        <span id="userName" class="text-sm font-medium text-gray-800 dark:text-gray-200"></span>
                        <span id="userRole" class="px-2 py-0.5 text-xs font-semibold text-white rounded-full"></span>
                    </div>
                    <!-- Auth Buttons -->
                    <div id="auth-container" class="flex items-center space-x-2">
                        <button id="signInBtn" type="button" class="px-3 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">Sign in with Google</button>
                        <button id="showSignupFormBtn" type="button" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition-all">Sign up</button>
                    </div>
                     <button id="signOutBtn" type="button" style="display:none;" class="px-3 py-2 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">Sign out</button>
                    <!-- Dark Mode Toggle -->
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
             <div class="pb-3 flex justify-center sm:justify-end items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                <span><span id="totalMembers" class="font-bold">0</span> Total Members</span>
                <span class="h-4 border-l border-gray-300 dark:border-gray-600"></span>
                <span><span id="onlineVisitors" class="font-bold">0</span> Online</span>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="bg-gray-200 dark:bg-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-4 h-12">
                <a href="./index.html" class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 dark:bg-indigo-500 rounded-md">Home</a>
                <a href="./contributor.html" class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Contributor Section</a>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
         <!-- Signup Form (hidden by default) -->
        <div id="signupForm" style="display:none;" class="mb-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md fade-in">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Create an Account</h3>
            <div class="space-y-4">
                <input type="text" id="signupUsername" placeholder="Username" class="w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="email" id="signupEmail" placeholder="Email address" class="w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div>
                    <div class="relative">
                        <input type="password" id="signupPassword" placeholder="Password" class="w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 pr-10">
                        <button type="button" id="togglePasswordVisibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 dark:text-gray-400">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.02 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                            <svg id="eyeSlashIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.955 9.955 0 00-4.502 1.071L3.707 2.293zM10.707 10.707a2 2 0 00-2.828-2.828l2.828 2.828zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                <path d="M2.043 10c1.274 4.057 5.02 7 9.542 7 .848 0 1.67-.11 2.458-.316l-1.473-1.473A10.014 10.014 0 012.043 10z" />
                            </svg>
                        </button>
                    </div>
                    <p id="passwordError" class="text-xs text-red-500 mt-1" style="display: none;"></p>
                </div>
                <button id="signupBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">Sign Up</button>
            </div>
        </div>

        <!-- Post Creation Section -->
        <section id="post-creation" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Create a New Post</h2>
            <textarea id="postContent" placeholder="What's on your mind?" class="w-full h-28 px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400 dark:placeholder-gray-500" disabled></textarea>
            <button id="createPostBtn" class="mt-4 px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed dark:disabled:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all" disabled>Create Post</button>
            <p id="auth-prompt" class="text-xs text-red-500 mt-2">Please sign in to create a post.</p>
        </section>

        <!-- Post List -->
        <div id="postList" class="mt-8 space-y-4">
            <!-- Posts will be dynamically inserted here -->
        </div>
    </main>
    
    <!-- Modals -->
    <div id="usernameModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl fade-in w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Choose a Username</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">This will be your public name in the forum.</p>
            <input type="text" id="modalUsernameInput" placeholder="Enter a unique username" class="w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <p id="usernameError" class="text-xs text-red-500 mt-1" style="display: none;"></p>
            <button id="submitUsernameBtn" class="mt-4 w-full px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">Confirm Username</button>
        </div>
    </div>
    
    <div id="adminModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl fade-in w-full max-w-md">
             <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Manage User</h3>
             <p id="adminModalUsername" class="text-sm font-medium text-indigo-600 dark:text-indigo-400 mb-4"></p>
             <div class="space-y-4">
                 <div>
                     <label for="warningMessage" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Send Warning</label>
                     <textarea id="warningMessage" placeholder="Enter warning message..." rows="3" class="mt-1 w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                     <button id="sendWarningBtn" class="mt-2 w-full px-4 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-md hover:bg-yellow-600 transition-all">Send Warning</button>
                 </div>
                 <div class="flex space-x-4">
                     <button id="banUserBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-all">Ban User</button>
                     <button id="unbanUserBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition-all">Unban User</button>
                 </div>
                 <button id="closeAdminModal" class="mt-4 w-full px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 transition-all">Close</button>
             </div>
        </div>
    </div>

    <div id="alertModal" style="display:none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl fade-in w-full max-w-sm text-center">
            <p id="alertMessage" class="text-gray-800 dark:text-gray-200 mb-4"></p>
            <button id="closeAlertModal" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">OK</button>
        </div>
    </div>

</div>

<script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, onSnapshot, addDoc, query, orderBy, where, getDocs, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDfAUIe4mrxSJ4SIlCDlTb7RehaD7fVog4",
      authDomain: "forum-3dec5.firebaseapp.com",
      databaseURL: "https://forum-3dec5-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "forum-3dec5",
      storageBucket: "forum-3dec5.firebasestorage.app",
      messagingSenderId: "519284298976",
      appId: "1:519284298976:web:8bb5e94a44f202802c2c85",
      measurementId: "G-SXS8FRTT03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // UI Elements
    const signInBtn = document.getElementById("signInBtn");
    const showSignupFormBtn = document.getElementById("showSignupFormBtn");
    const signupForm = document.getElementById("signupForm");
    const signupBtn = document.getElementById("signupBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const postList = document.getElementById("postList");
    const authContainer = document.getElementById("auth-container");
    const userInfoContainer = document.getElementById("userInfoContainer");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const signupPasswordInput = document.getElementById("signupPassword");
    const togglePasswordVisibilityBtn = document.getElementById("togglePasswordVisibility");
    const eyeIcon = document.getElementById("eyeIcon");
    const eyeSlashIcon = document.getElementById("eyeSlashIcon");
    const passwordError = document.getElementById("passwordError");

    let currentUserRole = null;
    
    // --- Custom Alert Modal ---
    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeAlertModal = document.getElementById('closeAlertModal');

    function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.style.display = 'flex';
    }
    closeAlertModal.onclick = () => alertModal.style.display = 'none';


    // --- Dark Mode ---
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);
    darkModeToggle.addEventListener("change", (e) => applyDarkMode(e.target.checked));

    // --- Password Visibility Toggle ---
    togglePasswordVisibilityBtn.addEventListener("click", () => {
        const type = signupPasswordInput.getAttribute("type") === "password" ? "text" : "password";
        signupPasswordInput.setAttribute("type", type);
        eyeIcon.classList.toggle("hidden");
        eyeSlashIcon.classList.toggle("hidden");
    });
    signupPasswordInput.addEventListener("input", () => {
        if (passwordError.style.display === 'block') {
            passwordError.style.display = 'none';
        }
    });

    // --- Authentication ---
    signInBtn.addEventListener("click", async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            await handleUser(result.user);
        } catch (error) {
            console.error("Google sign-in error:", error);
        }
    });
    showSignupFormBtn.addEventListener("click", () => {
        signupForm.style.display = signupForm.style.display === 'none' ? 'block' : 'none';
    });

    signupBtn.addEventListener("click", async () => {
        const email = document.getElementById("signupEmail").value;
        const password = signupPasswordInput.value;
        const username = document.getElementById("signupUsername").value.trim();
        
        passwordError.style.display = 'none';
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{7,16}$/;

        if (!email || !password || !username) {
            showAlert("Please fill out all fields.");
            return;
        }
        if (!passwordRegex.test(password)) {
            passwordError.textContent = "Must be 7-16 characters & contain a letter, number, & special character.";
            passwordError.style.display = 'block';
            return;
        }

        const usersRef = collection(db, "users");
        const q = query(usersRef, where("displayName", "==", username));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            showAlert("Username is already taken. Please choose another one.");
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await handleUser(userCredential.user, username);
            signupForm.style.display = 'none';
        } catch (error) {
            console.error("Email signup error:", error);
            showAlert(`Error: ${error.message}`);
        }
    });
    signOutBtn.addEventListener("click", () => signOut(auth));

    // --- User Management ---
    async function handleUser(user, chosenUsername = null) {
        if (!user) return;
        const userRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userRef);

        if (!userDoc.exists()) {
            const isAdmin = user.email === 'yujinbussinessmatter@gmail.com';
            const newUserRole = isAdmin ? 'admin' : 'newbie';

            if (chosenUsername) {
                await setDoc(userRef, {
                    uid: user.uid, email: user.email, displayName: chosenUsername,
                    createdAt: serverTimestamp(), role: newUserRole, banned: false, warnings: []
                });
            } else {
                const usernameModal = document.getElementById("usernameModal");
                usernameModal.style.display = 'flex';
                document.getElementById("submitUsernameBtn").onclick = async () => {
                    const modalUsernameInput = document.getElementById("modalUsernameInput");
                    const usernameError = document.getElementById("usernameError");
                    const newUsername = modalUsernameInput.value.trim();

                    if (!newUsername) {
                        usernameError.textContent = "Username cannot be empty.";
                        usernameError.style.display = "block";
                        return;
                    }
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("displayName", "==", newUsername));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        usernameError.textContent = "This username is already taken.";
                        usernameError.style.display = "block";
                    } else {
                        await setDoc(userRef, {
                            uid: user.uid, email: user.email, displayName: newUsername,
                            createdAt: serverTimestamp(), role: newUserRole, banned: false, warnings: []
                        });
                        usernameModal.style.display = 'none';
                    }
                };
            }
        }
    }
    
    // --- Auth State Observer ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            authContainer.style.display = 'none';
            signOutBtn.style.display = 'block';
            userInfoContainer.style.display = 'flex';
            document.getElementById("postContent").disabled = false;
            document.getElementById("createPostBtn").disabled = false;
            document.getElementById("auth-prompt").style.display = 'none';
            setupPresence(user);
            attachFirestoreListeners();

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                
                // Self-correction for admin role
                if (user.email === 'yujinbussinessmatter@gmail.com' && userData.role !== 'admin') {
                    await updateDoc(userDocRef, { role: 'admin' });
                    userData.role = 'admin'; // Update local data to prevent re-render flicker
                }

                currentUserRole = userData.role || 'newbie';

                userNameEl.textContent = userData.displayName || user.email;
                userRoleEl.textContent = currentUserRole;
                userRoleEl.className = 'px-2 py-0.5 text-xs font-semibold text-white rounded-full'; // Reset classes

                switch (currentUserRole) {
                    case 'admin': userRoleEl.classList.add('bg-violet-500'); break;
                    case 'contributor': userRoleEl.classList.add('bg-green-500'); break;
                    default: userRoleEl.classList.add('bg-blue-500'); break;
                }
            } else {
                userNameEl.textContent = user.email;
                userRoleEl.textContent = 'new';
                userRoleEl.classList.add('bg-gray-500');
            }
        } else {
            authContainer.style.display = 'flex';
            signOutBtn.style.display = 'none';
            userInfoContainer.style.display = 'none';
            document.getElementById("postContent").disabled = true;
            document.getElementById("createPostBtn").disabled = true;
            document.getElementById("auth-prompt").style.display = 'block';
            postList.innerHTML = '';
            currentUserRole = null;
            if(window.firestoreUnsubscribes) {
                window.firestoreUnsubscribes.forEach(unsub => unsub());
            }
        }
    });
    
    function setupPresence(user) { /* ... same as before ... */ }

    function attachFirestoreListeners() {
        if (window.firestoreUnsubscribes) {
             window.firestoreUnsubscribes.forEach(unsub => unsub());
        }
        window.firestoreUnsubscribes = [];

        const usersColRef = collection(db, "users");
        const usersUnsub = onSnapshot(usersColRef, (snapshot) => {
            document.getElementById("totalMembers").textContent = snapshot.size;
        });

        const statusRef = ref(rtdb, "status");
        const presenceUnsub = onValue(statusRef, (snapshot) => {
            document.getElementById("onlineVisitors").textContent = snapshot.exists() ? snapshot.size : 0;
        });

        const postsColRef = collection(db, "posts");
        const q = query(postsColRef, orderBy("createdAt", "desc"));
        const postsUnsub = onSnapshot(q, (snapshot) => {
            postList.innerHTML = '';
            snapshot.forEach(doc => {
                const post = doc.data();
                const postId = doc.id;
                const postEl = document.createElement('div');
                postEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md fade-in';
                const timestamp = post.createdAt ? post.createdAt.toDate().toLocaleString() : 'Just now';
                
                let adminControls = '';
                if (currentUserRole === 'admin') {
                    adminControls = `
                        <div class="ml-auto flex items-center space-x-2">
                             <button data-author-id="${post.authorId}" data-author-name="${post.authorName}" class="manage-user-btn p-1 text-gray-400 hover:text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-post-id="${postId}" class="delete-post-btn p-1 text-gray-400 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>`;
                }

                postEl.innerHTML = `
                    <div class="flex items-start">
                        <div>
                            <div class="font-bold text-gray-900 dark:text-white">${post.authorName}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${timestamp}</div>
                        </div>
                        ${adminControls}
                    </div>
                    <p class="text-gray-800 dark:text-gray-200 mt-2">${post.content}</p>
                `;
                postList.appendChild(postEl);
            });
        });
        window.firestoreUnsubscribes.push(usersUnsub, presenceUnsub, postsUnsub);
    }
    
    // --- Post Creation & Admin Actions---
    document.getElementById('createPostBtn').addEventListener('click', async () => {
        const content = document.getElementById("postContent").value.trim();
        const user = auth.currentUser;
        if (content && user && !user.isAnonymous) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists() && !userDocSnap.data().banned) {
                const postsColRef = collection(db, "posts");
                await addDoc(postsColRef, {
                    content: content,
                    authorId: user.uid,
                    authorName: userDocSnap.data().displayName,
                    createdAt: serverTimestamp(),
                });
                document.getElementById("postContent").value = '';
            } else if (userDocSnap.data().banned) {
                showAlert("Your account is banned and you cannot create posts.");
            }
        }
    });

    postList.addEventListener('click', e => {
        const deleteBtn = e.target.closest('.delete-post-btn');
        const manageBtn = e.target.closest('.manage-user-btn');

        if (deleteBtn) {
            const postId = deleteBtn.dataset.postId;
            if (confirm('Are you sure you want to delete this post permanently?')) {
                deleteDoc(doc(db, "posts", postId)).then(() => {
                    showAlert('Post deleted successfully.');
                }).catch(err => console.error("Error deleting post:", err));
            }
        }
        if (manageBtn) {
            const userId = manageBtn.dataset.authorId;
            const userName = manageBtn.dataset.authorName;
            openAdminModal(userId, userName);
        }
    });

    const adminModal = document.getElementById('adminModal');
    let targetUserId = null;

    function openAdminModal(userId, userName) {
        targetUserId = userId;
        document.getElementById('adminModalUsername').textContent = userName;
        document.getElementById('warningMessage').value = '';
        adminModal.style.display = 'flex';
    }
    document.getElementById('closeAdminModal').onclick = () => adminModal.style.display = 'none';

    document.getElementById('banUserBtn').onclick = async () => {
        if (!targetUserId) return;
        await updateDoc(doc(db, "users", targetUserId), { banned: true });
        showAlert('User has been banned.');
        adminModal.style.display = 'none';
    };
    document.getElementById('unbanUserBtn').onclick = async () => {
        if (!targetUserId) return;
        await updateDoc(doc(db, "users", targetUserId), { banned: false });
        showAlert('User has been unbanned.');
        adminModal.style.display = 'none';
    };
    document.getElementById('sendWarningBtn').onclick = async () => {
        if (!targetUserId) return;
        const message = document.getElementById('warningMessage').value.trim();
        if(message){
            await updateDoc(doc(db, "users", targetUserId), { 
                warnings: arrayUnion({ message: message, date: serverTimestamp() })
            });
            showAlert('Warning has been sent.');
            adminModal.style.display = 'none';
        } else {
            showAlert('Warning

